##
# DOCKER COMPOSE - ONETIME SECRET (FULL STACK)
#
# Full production deployment: Caddy TLS proxy, App, Valkey, RabbitMQ,
# background workers, and scheduler.
#
# See docker/README.md for complete setup and usage documentation.

services:
  proxy:
    build:
      context: ../..
      dockerfile: docker/variants/caddy.dockerfile
    container_name: onetime-proxy
    depends_on:
      app:
        condition: service_started
    environment:
      - DOMAIN=${DOMAIN:-localhost}
      - CERTIFICATE_EMAIL=${CERTIFICATE_EMAIL:-admin@example.com}
      - PUBLIC_DIR=/var/www/public
    logging:
      driver: 'json-file'
      options:
        max-size: '60m'
        max-file: '3'
    networks:
      - onetime-network
    ports:
      - '80:80'
      - '443:443'
    # Note: Port 2019 is NOT exposed externally - only to the other containers on the same network
    expose:
      - '2019'
    restart: unless-stopped
    volumes:
      - ../../etc/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config

  app:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: onetime-app
    depends_on:
      maindb:
        condition: service_healthy
    env_file:
      - ../../.env
    environment:
      - RACK_ENV=${RACK_ENV:-production}
      - REDIS_URL=redis://maindb:6379/0
      - AUTH_DATABASE_URL=sqlite://data/auth.db
      - SECRET=${SECRET:?SECRET must be set â€” run rake ots:secrets}
      - SESSION_SECRET=${SESSION_SECRET:-}
      - AUTH_SECRET=${AUTH_SECRET:-}
      - AUTHENTICATION_MODE=${AUTHENTICATION_MODE:-full}
      - ARGON2_SECRET=${ARGON2_SECRET:-}
      - FEDERATION_SECRET=${FEDERATION_SECRET:-}
      - IDENTIFIER_SECRET=${IDENTIFIER_SECRET:-}
      - PUBLIC_DIR=/var/www/public
    entrypoint: ['./bin/entrypoint.sh']
    stdin_open: true
    tty: true
    logging:
      driver: 'json-file'
      options:
        max-size: '60m'
        max-file: '3'
    networks:
      - onetime-network
    expose:
      - '3000'
    restart: unless-stopped
    volumes:
      - ../../data:/app/data

  maindb:
    image: valkey/valkey:8.0-bookworm@sha256:3fb1247c0ae098a109f49e86a00bbae330044d610a608228a8350c0287c1e4f1
    container_name: onetime-maindb
    command: >
      valkey-server
      --appendonly yes
      --appendfilename onetime.aof
      --appendfsync everysec
      --dbfilename onetime.rdb
      --save 157680000 1
      --bind 0.0.0.0
      --port 6379
      --databases 1
      --timeout 30
      --loglevel notice
      --rdbcompression yes
    logging:
      driver: 'json-file'
      options:
        max-size: '60m'
        max-file: '3'
    networks:
      - onetime-network
    # Note: Port 6379 is NOT exposed externally - only to containers on the same network
    expose:
      - '6379'
    restart: unless-stopped
    volumes:
      - maindb-data:/data
    healthcheck:
      test: ['CMD', 'valkey-cli', 'ping']
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  rabbitmq:
    image: rabbitmq:4.0-management
    container_name: onetime-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS:-guest}
      - RABBITMQ_DEFAULT_VHOST=/
    logging:
      driver: 'json-file'
      options:
        max-size: '60m'
        max-file: '3'
    networks:
      - onetime-network
    # Note: Ports are NOT exposed externally - only to containers on the same network
    expose:
      - '5672' # AMQP
      - '15672' # Management UI
    restart: unless-stopped
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ['CMD', 'rabbitmq-diagnostics', 'check_port_connectivity']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  worker-email:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: onetime-worker-email
    depends_on:
      maindb:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    env_file:
      - ../../.env
    environment:
      - RACK_ENV=${RACK_ENV:-production}
      - REDIS_URL=redis://maindb:6379/0
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@rabbitmq:5672
      - ONETIME_HOME=/app
    command:
      [
        './bin/ots',
        'jobs',
        'worker',
        '--queues',
        'email',
        '--concurrency',
        '5',
        '--environment',
        'production',
      ]
    logging:
      driver: 'json-file'
      options:
        max-size: '60m'
        max-file: '3'
    networks:
      - onetime-network
    restart: unless-stopped
    volumes:
      - ../..:/app

  scheduler:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: onetime-scheduler
    depends_on:
      maindb:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    env_file:
      - ../../.env
    environment:
      - RACK_ENV=${RACK_ENV:-production}
      - REDIS_URL=redis://maindb:6379/0
      - VALKEY_URL=redis://maindb:6379/0
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@rabbitmq:5672
      - ONETIME_HOME=/app
    command: ['./bin/ots', 'jobs', 'scheduler', '--environment', 'production']
    logging:
      driver: 'json-file'
      options:
        max-size: '60m'
        max-file: '3'
    networks:
      - onetime-network
    restart: unless-stopped
    volumes:
      - ../..:/app

networks:
  onetime-network:
    driver: bridge
    name: onetime-network

volumes:
  maindb-data:
    name: onetime_maindb_data
  rabbitmq-data:
    name: onetime_rabbitmq_data
  caddy-data:
    name: onetime_caddy_data
  caddy-config:
    name: onetime_caddy_config

#!/bin/bash

# Wrapper to fix structural conflicts in all locale directories
#
# Usage: ./fix-all-locale-conflicts [-q quiet] [-f filename-only] [-v verbose] [-c copy-values]
#
# Options:
#   -q: Suppress all output except summary
#   -f: Only output filenames of files that failed to fix
#   -v: Show verbose fix details
#   -c: Copy values from base file for missing keys
#
# Exit: 0 if all fixes succeed, 1 if any fail

SCRIPT_DIR=$(dirname "$(readlink -f "$0")")

EXIT_CODE=0
FIXED_LOCALES=0
FAILED_LOCALES=0
TOTAL_LOCALES=0

for locale_dir in ../../../locales/*/; do
  [ ! -d "$locale_dir" ] && continue

  locale_name=$(basename "$locale_dir")
  [ "$locale_name" = "en" ] && continue

  TOTAL_LOCALES=$((TOTAL_LOCALES + 1))

  if "$SCRIPT_DIR/fix-locale-conflicts" "$@" "$locale_name"; then
    FIXED_LOCALES=$((FIXED_LOCALES + 1))
  else
    EXIT_CODE=1
    FAILED_LOCALES=$((FAILED_LOCALES + 1))
  fi
done

# Summary unless in filename-only mode
if [ "$1" != "-f" ]; then
  echo "=========================================="
  echo "CONFLICT FIX SUMMARY: $FIXED_LOCALES fixed, $FAILED_LOCALES failed of $TOTAL_LOCALES locales"
  [ $FAILED_LOCALES -eq 0 ] && echo "✓ All locale directories have been fixed for structural conflicts"
  [ $FAILED_LOCALES -gt 0 ] && echo "⚠ $FAILED_LOCALES locales still have issues"
fi

exit $EXIT_CODE

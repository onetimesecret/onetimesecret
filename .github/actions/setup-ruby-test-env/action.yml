# .github/actions/setup-ruby-test-env/action.yml
---
# ==============================================================================
# Setup Ruby Test Environment - Composite Action
# ==============================================================================
# Version: 1.0.0
# Repository: onetimesecret/onetimesecret
#
# Prepares a complete Ruby test environment for CI jobs. Consolidates common
# setup steps used across multiple Ruby test jobs.
#
# Setup Steps:
#   1. Download frontend build artifacts (optional)
#   2. Verify downloaded assets exist
#   3. Enable memory overcommit for Redis
#   4. Setup Ruby with bundler caching
#   5. Install gem dependencies
#   6. Copy default config files to etc/
#   7. Generate ephemeral test secrets
#
# Usage:
#   - uses: ./.github/actions/setup-ruby-test-env
#     with:
#       ruby-version: '3.4'
#       download-artifacts: 'true'
#
# Changelog:
#   1.0.0 - Initial release consolidating Ruby setup from ci.yml
# ==============================================================================

name: Setup Ruby Test Environment
description: |
  Sets up a complete Ruby test environment for CI jobs.
  Handles artifact download, asset verification, system config,
  Ruby/bundler setup, dependencies, config files, and test secrets.

inputs:
  ruby-version:
    description: 'Ruby version to use'
    required: false
    default: '3.4'
  download-artifacts:
    description: 'Whether to download frontend build artifacts'
    required: false
    default: 'true'
  artifact-name:
    description: 'Name of the artifact to download'
    required: false
    default: 'frontend-build'
  artifact-path:
    description: 'Path to download artifacts to'
    required: false
    default: 'public/web/dist/'

runs:
  using: composite
  steps:
    - name: Download build artifacts
      if: inputs.download-artifacts == 'true'
      uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
      with:
        name: ${{ inputs.artifact-name }}
        path: ${{ inputs.artifact-path }}

    - name: Verify downloaded assets
      if: inputs.download-artifacts == 'true'
      shell: bash
      run: |
        if [ ! -d "${{ inputs.artifact-path }}" ] || [ -z "$(ls -A "${{ inputs.artifact-path }}")" ]; then
          echo "::error::Frontend assets not found or empty at ${{ inputs.artifact-path }}"
          exit 1
        fi
        echo "::notice::Frontend assets verified at ${{ inputs.artifact-path }}"

    - name: Enable memory overcommit for Redis
      shell: bash
      run: sudo sysctl -w vm.overcommit_memory=1

    - name: Setup Ruby
      uses: ruby/setup-ruby@0fa965176eabbb494a5778ac04477b260840ef45
      with:
        ruby-version: ${{ inputs.ruby-version }}
        bundler-cache: true

    - name: Install dependencies
      shell: bash
      run: |
        bundle config path vendor/bundle
        bundle install --jobs 4 --retry 3

    - name: Setup test configuration
      shell: bash
      run: |
        for file in etc/defaults/*.defaults.*; do
          if [ -f "$file" ]; then
            target="etc/$(basename "$file" | sed 's/\.defaults//')"
            if [ ! -f "$target" ]; then
              cp "$file" "$target"
              echo "Created $target from defaults"
            fi
          fi
        done

    - name: Generate random secrets for testing
      uses: ./.github/actions/generate-test-secrets

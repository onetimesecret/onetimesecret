# .github/workflows/build-and-publish-oci-images.yml

name: Build and Publish OCI Images

#
# OCI image tagging strategy:
#
# Release tags (v1.0.0):        {version}, latest
# Release candidates (v1.0.0-rc1): {version}, next
# Branches (feature/x):         {branch-name}
#
# Tags are computed by bake.hcl from VERSION and EXTRA_TAGS variables.
#

on:
  push:
    tags: ['v*']
  pull_request:
    types: [closed]
    branches: ['develop', 'feature/*', 'rel/*']
    # Don't deploy on PRs from forks
    paths-ignore:
      - '**'

  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Enable debug mode for build troubleshooting'
        required: false
        default: false
      platforms:
        type: choice
        description: 'Target platforms'
        required: false
        default: 'linux/amd64,linux/arm64'
        options:
          - 'linux/amd64,linux/arm64'
          - 'linux/amd64'
          - 'linux/arm64'

permissions:
  contents: read
  packages: write

jobs:
  build-and-publish:
    uses: ./.github/workflows/.build-and-publish-oci-images-reusable.yml
    with:
      bake_group: ci
      image_tags: >-
        ${{ contains(github.ref, '-rc') && 'next' ||
            contains(github.ref, 'develop') && 'next' ||
            startsWith(github.ref, 'refs/tags/v') && 'latest' ||
            '' }}
      debug_enabled: ${{ inputs.debug_enabled || false }}
      platforms: ${{ inputs.platforms || 'linux/amd64,linux/arm64' }}
    secrets: inherit

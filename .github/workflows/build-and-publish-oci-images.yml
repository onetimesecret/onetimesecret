# .github/workflows/build-and-publish-oci-images.yml
---
name: Build and Publish OCI Images

#
# OCI image tagging strategy:
#
# Release tags (v1.0.0):          {version}, latest
# Release candidates (v1.0.0-rc1): {version}, next
# Branch push:                    {branch-name}, edge
# Manual dispatch:                {branch-name}, dev (or version_tag if provided)
# Scheduled (nightly):            nightly
#
# Architecture:
#   Uses docker/bake-action with docker/bake.hcl to build all image
#   variants in a single job. Bake resolves the dependency graph
#   (base → dependencies → build → final) automatically.
#
# Debug Logging (Repository Variables):
#   ACTIONS_STEP_DEBUG=true    Enable purple debug output for all steps
#   ACTIONS_RUNNER_DEBUG=true  Enable runner diagnostic logging
#   Set in Settings → Secrets and variables → Actions → Variables
#

on:
  push:
    tags: ['v*']
  pull_request:
    types: [closed]
    branches: ['develop', 'feature/*', 'rel/*']
    # Don't deploy on PRs from forks
    paths-ignore:
      - '**'

  schedule:
    # Nightly build at 03:00 UTC (off-peak hours)
    - cron: '0 3 * * *'

  workflow_dispatch:
    inputs:
      source_branch:
        type: string
        description: 'Branch to build from (defaults to the branch selected in the UI)'
        required: false
        default: ''
      version_tag:
        type: string
        description: 'Version tag for the image (e.g., "0.18.0-beta.1"). Does NOT create a git tag.'
        required: false
        default: ''
      registry_target:
        type: choice
        description: 'Target registry for built images'
        required: false
        default: 'custom'
        options:
          - 'custom'
          - 'public'
      debug_enabled:
        type: boolean
        description: 'Enable debug mode for build troubleshooting'
        required: false
        default: false
      platforms:
        type: choice
        description: 'Target platforms'
        required: false
        # default: 'linux/amd64,linux/arm64'
        default: 'linux/amd64'
        options:
          - ''
          - 'linux/amd64'
          - 'linux/amd64,linux/arm64'
          - 'linux/arm64'

permissions:
  contents: read
  packages: write

jobs:
  build-and-publish:
    name: Build OCI Images
    runs-on: ubuntu-24.04
    if: github.repository == 'onetimesecret/onetimesecret'

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ inputs.source_branch || github.ref }}

      - name: Generate commit hash
        id: commit
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          echo "${SHORT_SHA}" > .commit_hash.txt
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Commit hash recorded: ${SHORT_SHA}"

      - name: Update package.json version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: ./.github/scripts/update-version.sh

      - name: Compute version and tags
        id: version
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_VERSION_TAG: ${{ inputs.version_tag }}
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Build comma-separated list of extra tags based on event context
          EXTRA_TAGS=""

          # Release tag (v1.0.0 → latest; v1.0.0-rc1 → next)
          if [[ "$GITHUB_REF" =~ ^refs/tags/v ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            if [[ "$TAG_NAME" == *"-rc"* ]]; then
              EXTRA_TAGS="next"
            else
              EXTRA_TAGS="latest"
            fi
          fi

          # Branch push → edge
          if [[ "$EVENT_NAME" == "push" ]] && [[ ! "$GITHUB_REF" =~ ^refs/tags/ ]]; then
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            # Sanitize branch name for Docker tag (replace / with -)
            BRANCH_TAG=$(echo "$BRANCH_NAME" | sed 's|/|-|g')
            EXTRA_TAGS="${EXTRA_TAGS:+${EXTRA_TAGS},}${BRANCH_TAG},edge"
          fi

          # develop branch → next
          if [[ "$GITHUB_REF" == "refs/heads/develop" ]]; then
            EXTRA_TAGS="${EXTRA_TAGS:+${EXTRA_TAGS},}next"
          fi

          # Manual dispatch
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            if [[ -n "$INPUT_VERSION_TAG" ]]; then
              EXTRA_TAGS="${EXTRA_TAGS:+${EXTRA_TAGS},}${INPUT_VERSION_TAG}"
            else
              EXTRA_TAGS="${EXTRA_TAGS:+${EXTRA_TAGS},}dev"
            fi
          fi

          # Nightly schedule
          if [[ "$EVENT_NAME" == "schedule" ]]; then
            EXTRA_TAGS="${EXTRA_TAGS:+${EXTRA_TAGS},}nightly"
          fi

          echo "extra_tags=${EXTRA_TAGS}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
          echo "Extra tags: ${EXTRA_TAGS}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0
        with:
          platforms: arm64

      - name: Setup Docker buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0
        with:
          platforms: ${{ inputs.platforms || 'linux/amd64' }}

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request' && (inputs.registry_target || 'public') != 'custom'
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log into GitHub Container Registry
        if: github.event_name != 'pull_request' && (inputs.registry_target || 'public') != 'custom'
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log into custom registry
        if: github.event_name != 'pull_request' && (inputs.registry_target || 'public') == 'custom'
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ secrets.CUSTOM_REGISTRY_HOST }}
          username: ${{ secrets.CUSTOM_REGISTRY_USERNAME }}
          password: ${{ secrets.CUSTOM_REGISTRY_PASSWORD }}

      - name: Build and push with Bake
        uses: docker/bake-action@5be5f02ff8819ecd3092ea6b2e6261c31774f2b4 # v6.10.0
        env:
          VERSION: ${{ steps.version.outputs.version }}
          COMMIT_HASH: ${{ steps.commit.outputs.short_sha }}
          EXTRA_TAGS: ${{ steps.version.outputs.extra_tags }}
          PLATFORMS: ${{ inputs.platforms || 'linux/amd64' }}
          REGISTRY_MODE: ${{ inputs.registry_target || 'public' }}
          CUSTOM_REGISTRY: ${{ secrets.CUSTOM_REGISTRY_HOST }}
        with:
          files: docker/bake.hcl
          targets: ci
          push: ${{ github.event_name != 'pull_request' }}
          set: |
            *.args.VERSION=${{ steps.version.outputs.version }}
            *.args.COMMIT_HASH=${{ steps.commit.outputs.short_sha }}

      - name: Output build summary
        env:
          BUILD_PLATFORMS: ${{ inputs.platforms || 'linux/amd64' }}
          BUILD_VERSION: ${{ steps.version.outputs.version }}
          BUILD_COMMIT: ${{ steps.commit.outputs.short_sha }}
          BUILD_EXTRA_TAGS: ${{ steps.version.outputs.extra_tags }}
        run: |
          {
            echo "## OCI Image Build Complete"
            echo ""
            echo "**Bake file:** docker/bake.hcl"
            echo "**Targets:** ci (main, s6, lite)"
            echo "**Platforms:** ${BUILD_PLATFORMS}"
            echo "**Version:** ${BUILD_VERSION}"
            echo "**Commit:** ${BUILD_COMMIT}"
            echo "**Extra tags:** ${BUILD_EXTRA_TAGS}"
          } >> "$GITHUB_STEP_SUMMARY"

# .github/workflows/build-and-publish-oci-images.yml
---
name: Build and Publish OCI Images

#
# OCI image tagging strategy:
#
# Release tags (v1.0.0):        {version}, latest
# Release candidates (v1.0.0-rc1): {version}, next
# Branch push:                  {branch-name}, edge
# Manual dispatch:              {branch-name}, dev
# Scheduled (nightly):          nightly
#
# This ensures stable releases are tagged as 'latest' while release candidates
# are tagged as 'next' for early testing. Branch builds get descriptive tags.
#
# Architecture:
#   Uses composite action .github/actions/build-and-publish-oci-image
#   to align with the pattern established in ci.yml
#
# Debug Logging (Repository Variables):
#   ACTIONS_STEP_DEBUG=true    Enable purple debug output for all steps
#   ACTIONS_RUNNER_DEBUG=true  Enable runner diagnostic logging
#   Set in Settings → Secrets and variables → Actions → Variables
#

on:
  push:
    tags: ['v*']
  pull_request:
    types: [closed]
    branches: ['develop', 'feature/*', 'rel/*']
    # Don't deploy on PRs from forks
    paths-ignore:
      - '**'

  schedule:
    # Nightly build at 03:00 UTC (off-peak hours)
    - cron: '0 3 * * *'

  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Enable debug mode for build troubleshooting'
        required: false
        default: false
      platforms:
        type: choice
        description: 'Target platforms'
        required: false
        # default: 'linux/amd64,linux/arm64'
        default: 'linux/amd64'
        options:
          - ''
          - 'linux/amd64'
          - 'linux/amd64,linux/arm64'
          - 'linux/arm64'

permissions:
  contents: read
  packages: write

jobs:
  build-and-publish-main:
    name: Build Main Image
    runs-on: ubuntu-24.04
    if: github.repository == 'onetimesecret/onetimesecret'

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build and publish OCI image
        uses: ./.github/actions/build-and-publish-oci-image
        with:
          image-suffix: ''
          dockerfile: 'Dockerfile'
          platforms: ${{ inputs.platforms || 'linux/amd64' }}
          push: ${{ github.event_name != 'pull_request' }}
          image-tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value=next,enable=${{ contains(github.ref, '-rc') || contains(github.ref, 'develop') }}
            type=raw,value=edge,enable=${{ github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/') }}
            type=raw,value=dev,enable=${{ github.event_name == 'workflow_dispatch' }}
            type=raw,value=nightly,enable=${{ github.event_name == 'schedule' }}
          dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  build-and-publish-lite:
    name: Build Lite Image
    runs-on: ubuntu-24.04
    needs: [build-and-publish-main]
    if: github.repository == 'onetimesecret/onetimesecret'

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build and publish OCI image
        uses: ./.github/actions/build-and-publish-oci-image
        with:
          image-suffix: '-lite'
          dockerfile: 'docker/variants/lite.dockerfile'
          platforms: ${{ inputs.platforms || 'linux/amd64' }}
          push: ${{ github.event_name != 'pull_request' }}
          image-tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value=next,enable=${{ contains(github.ref, '-rc') || contains(github.ref, 'develop') }}
            type=raw,value=edge,enable=${{ github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/') }}
            type=raw,value=dev,enable=${{ github.event_name == 'workflow_dispatch' }}
            type=raw,value=nightly,enable=${{ github.event_name == 'schedule' }}
          dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  build-and-publish-s6:
    name: Build S6 Multi-Process Image
    runs-on: ubuntu-24.04
    needs: [build-and-publish-main]
    if: github.repository == 'onetimesecret/onetimesecret'

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build and publish OCI image
        uses: ./.github/actions/build-and-publish-oci-image
        with:
          image-suffix: '-s6'
          dockerfile: 'Dockerfile'
          build-target: 'final-s6'
          platforms: ${{ inputs.platforms || 'linux/amd64' }}
          push: ${{ github.event_name != 'pull_request' }}
          image-tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value=next,enable=${{ contains(github.ref, '-rc') || contains(github.ref, 'develop') }}
            type=raw,value=edge,enable=${{ github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/') }}
            type=raw,value=dev,enable=${{ github.event_name == 'workflow_dispatch' }}
            type=raw,value=nightly,enable=${{ github.event_name == 'schedule' }}
          dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

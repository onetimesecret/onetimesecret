# .github/workflows/build-and-publish-oci-images.yml
---
name: Build and Publish OCI Images

#
# OCI image tagging strategy:
#
# Release tags (v1.0.0):        {version}, latest
# Release candidates (v1.0.0-rc1): {version}, next
# Branches (feature/x):         {branch-name}
#
# This ensures stable releases are tagged as 'latest' while release candidates
# are tagged as 'next' for early testing. Branch builds get descriptive tags.
#
# Architecture:
#   Uses composite action .github/actions/build-and-publish-oci-image
#   to align with the pattern established in ci.yml
#
# Debug Logging (Repository Variables):
#   ACTIONS_STEP_DEBUG=true    Enable purple debug output for all steps
#   ACTIONS_RUNNER_DEBUG=true  Enable runner diagnostic logging
#   Set in Settings → Secrets and variables → Actions → Variables
#

on:
  push:
    tags: ['v*']
  pull_request:
    types: [closed]
    branches: ['develop', 'feature/*', 'rel/*']
    # Don't deploy on PRs from forks
    paths-ignore:
      - '**'

  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Enable debug mode for build troubleshooting'
        required: false
        default: false
      platforms:
        type: choice
        description: 'Target platforms'
        required: false
        default: 'linux/amd64,linux/arm64'
        options:
          - 'linux/amd64,linux/arm64'
          - 'linux/amd64'
          - 'linux/arm64'

permissions:
  contents: read
  packages: write

jobs:
  build-and-publish-main:
    name: Build Main Image
    runs-on: ubuntu-24.04
    if: github.repository == 'onetimesecret/onetimesecret'

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Build and publish OCI image
        uses: ./.github/actions/build-and-publish-oci-image
        with:
          image-suffix: ''
          dockerfile: 'Dockerfile'
          platforms: ${{ inputs.platforms || 'linux/amd64,linux/arm64' }}
          push: ${{ github.event_name != 'pull_request' }}
          image-tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value=next,enable=${{ contains(github.ref, '-rc') || contains(github.ref, 'develop') }}
          dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  build-and-publish-lite:
    name: Build Lite Image
    runs-on: ubuntu-24.04
    needs: [build-and-publish-main]
    if: github.repository == 'onetimesecret/onetimesecret'

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Build and publish OCI image
        uses: ./.github/actions/build-and-publish-oci-image
        with:
          image-suffix: '-lite'
          dockerfile: 'Dockerfile-lite'
          platforms: ${{ inputs.platforms || 'linux/amd64,linux/arm64' }}
          push: ${{ github.event_name != 'pull_request' }}
          image-tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value=next,enable=${{ contains(github.ref, '-rc') || contains(github.ref, 'develop') }}
          dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

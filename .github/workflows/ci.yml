# .github/workflows/ci.yml
---
name: CI

# Main CI workflow that runs Ruby tests using RSpec and tryouts, plus TypeScript
# tests using Vitest and validation steps (linting, type-checking).
#
# Architecture (Phase 5 - Composite Actions):
# - Tier 0: Path filtering to skip irrelevant jobs
# - Tier 1: Lint jobs + build-assets (parallel, fast feedback)
# - Tier 2: Unit tests (ruby-unit, typescript-unit)
# - Tier 3: Integration tests by auth mode (parallel: simple, full, disabled)
# - Tier 4: Container validation uses pre-built assets
#
# Composite Actions:
# - setup-ruby-test-env: Ruby environment, artifacts, config, secrets
# - setup-node-env: Node.js, pnpm, caching
# - run-ruby-tests: Parameterized RSpec/Tryouts execution
#
# Path Filtering:
# - Ruby-only changes skip TypeScript jobs
# - TypeScript-only changes skip Ruby jobs
# - Workflow file changes (.github/**) run all jobs
# - Use [ci-all] in commit message to force all jobs
# - Use [ci-skip] in commit message to skip CI entirely
#
# Debug Logging (Repository Variables):
# - ACTIONS_STEP_DEBUG=true    Enable purple debug output for all steps
# - ACTIONS_RUNNER_DEBUG=true  Enable runner diagnostic logging
# - Set in Settings â†’ Secrets and variables â†’ Actions â†’ Variables

on:
  push:
    branches:
      - fix/*
      - rel/*
  pull_request:
    branches:
      - main
      - develop
      - feature/*
      - rel/*
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled'
        required: false
        default: false
      run_all:
        type: boolean
        description: 'Run all CI jobs (skip path filtering)'
        required: false
        default: false

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # TIER 0: PATH FILTERING (~5s)
  # ============================================================================

  changes:
    name: Detect Changes
    runs-on: &runs-on ubuntu-24.04
    timeout-minutes: 2
    outputs:
      ruby: ${{ steps.compute.outputs.ruby }}
      typescript: ${{ steps.compute.outputs.typescript }}
      frontend: ${{ steps.compute.outputs.frontend }}
      oci: ${{ steps.compute.outputs.oci }}
      ga_workflow_files: ${{ steps.compute.outputs.ga_workflow_files }}
      test-paths: ${{ steps.load-config.outputs.test-paths }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Check for CI flags
        id: check-flags
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -q '\[ci-skip\]'; then
            echo "skip_ci=true" >> $GITHUB_OUTPUT
          else
            echo "skip_ci=false" >> $GITHUB_OUTPUT
          fi
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.run_all }}" == "true" ]]; then
            echo "run_all=true" >> $GITHUB_OUTPUT
          elif echo "$COMMIT_MSG" | grep -q '\[ci-all\]'; then
            echo "run_all=true" >> $GITHUB_OUTPUT
          else
            echo "run_all=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect file changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            ruby:
              - '**/*.rb'
              - 'Gemfile'
              - 'Gemfile.lock'
              - '.rubocop.yml'
              - '.rubocop_todo.yml'
              - '.ruby-version'
              - '.rspec'
              - 'spec/**'
              - 'try/**'
              - 'apps/**'
              - 'lib/**'
              - 'bin/**'
              - 'config.ru'
            typescript:
              - 'src/**/*.ts'
              - 'src/**/*.vue'
              - 'src/**/*.tsx'
              - 'src/**/*.js'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'tsconfig.json'
              - 'tsconfig.*.json'
              - 'vite.config.ts'
              - 'vitest.config.ts'
              - 'tailwind.config.ts'
              - 'eslint.config.ts'
              - '.eslintrc*'
              - '.nvmrc'
              - '.node-version'
              - 'tests/**'
            frontend:
              - 'src/**'
              - 'public/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'vite.config.ts'
              - 'tailwind.config.ts'
              - 'postcss.config.*'
            oci:
              - 'Dockerfile*'
              - 'docker/**'
              - 'scripts/entrypoint.sh'
              - 'etc/**'
              - 'config.ru'
            ga_workflow_files:
              - '.github/workflows/**'
              - '.github/actions/**'

      - name: Compute final outputs
        id: compute
        run: |
          SKIP_CI="${{ steps.check-flags.outputs.skip_ci }}"
          RUN_ALL="${{ steps.check-flags.outputs.run_all }}"
          GA_WORKFLOWS="${{ steps.filter.outputs.ga_workflow_files }}"

          if [[ "$SKIP_CI" == "true" ]]; then
            echo "ruby=false" >> $GITHUB_OUTPUT
            echo "typescript=false" >> $GITHUB_OUTPUT
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "oci=false" >> $GITHUB_OUTPUT
            echo "ga_workflow_files=false" >> $GITHUB_OUTPUT
          elif [[ "$RUN_ALL" == "true" || "$GA_WORKFLOWS" == "true" ]]; then
            echo "ruby=true" >> $GITHUB_OUTPUT
            echo "typescript=true" >> $GITHUB_OUTPUT
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "oci=true" >> $GITHUB_OUTPUT
            echo "ga_workflow_files=true" >> $GITHUB_OUTPUT
          else
            echo "ruby=${{ steps.filter.outputs.ruby }}" >> $GITHUB_OUTPUT
            echo "typescript=${{ steps.filter.outputs.typescript }}" >> $GITHUB_OUTPUT
            echo "frontend=${{ steps.filter.outputs.frontend }}" >> $GITHUB_OUTPUT
            echo "oci=${{ steps.filter.outputs.oci }}" >> $GITHUB_OUTPUT
            echo "ga_workflow_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Load test paths config
        id: load-config
        run: |
          # Test paths are defined in .github/ci-test-paths.json
          # Edit that file to add/modify test directories for each job
          CONFIG=$(cat .github/ci-test-paths.json | jq -c '.')
          echo "test-paths=$CONFIG" >> $GITHUB_OUTPUT

      - name: Generate job summary
        run: |
          echo "## Path Filter Results" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Final |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ruby | ${{ steps.compute.outputs.ruby }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ steps.compute.outputs.typescript }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.compute.outputs.frontend }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OCI | ${{ steps.compute.outputs.oci }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # TIER 1: LINT & BUILD JOBS (~30-45s)
  # ============================================================================

  ruby-lint:
    name: Ruby Lint
    timeout-minutes: 5
    runs-on: *runs-on
    needs: [changes]
    if: needs.changes.outputs.ruby == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - uses: ruby/setup-ruby@ab177d40ee5483edb974554986f56b33477e21d0
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Run Rubocop
        run: |
          mkdir -p tmp
          bundle exec rubocop --config .rubocop.yml \
            --format progress \
            --format json --out tmp/rubocop_results.json \
            --fail-level warning

      - name: Upload Rubocop results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rubocop-results
          path: tmp/rubocop_results.json
          retention-days: 7

  typescript-lint:
    name: TypeScript Lint
    timeout-minutes: 5
    runs-on: *runs-on
    needs: [changes]
    if: needs.changes.outputs.typescript == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node.js environment
        uses: ./.github/actions/setup-node-env

      - name: Run type checking
        run: pnpm type-check

      - name: Run linting
        run: pnpm lint

  build-assets:
    name: Build Frontend Assets
    timeout-minutes: 10
    runs-on: *runs-on
    needs: [changes]
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.ruby == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node.js environment
        uses: ./.github/actions/setup-node-env

      - name: Build assets
        run: pnpm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: public/web/dist/
          retention-days: 1
          if-no-files-found: error

  # ============================================================================
  # TIER 2: UNIT TESTS (~30-45s)
  # ============================================================================

  ruby-unit:
    name: Ruby Unit Tests
    timeout-minutes: 10
    runs-on: *runs-on
    needs: [changes, ruby-lint, build-assets]
    if: |
      always() &&
      needs.changes.outputs.ruby == 'true' &&
      (needs.ruby-lint.result == 'success' || needs.ruby-lint.result == 'skipped') &&
      (needs.build-assets.result == 'success' || needs.build-assets.result == 'skipped')

    services:
      redis: &valkey-service
        image: ghcr.io/valkey-io/valkey:8.1.3-bookworm@sha256:fea8b3e67b15729d4bb70589eb03367bab9ad1ee89c876f54327fc7c6e618571
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 5
          --memory=4g
        ports:
          - 2121:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Ruby test environment
        uses: ./.github/actions/setup-ruby-test-env

      - name: Run Ruby tests
        uses: ./.github/actions/run-ruby-tests
        with:
          test-type: unit
          auth-mode: simple
          tryouts-paths: ${{ fromJSON(needs.changes.outputs.test-paths).ruby-unit.tryouts-paths }}
          rspec-paths: ${{ fromJSON(needs.changes.outputs.test-paths).ruby-unit.rspec-paths }}
          results-file: 'rspec_unit_results.json'
          debug-enabled: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}

  typescript-unit:
    name: TypeScript Unit Tests
    timeout-minutes: 15
    runs-on: *runs-on
    needs: [changes, typescript-lint]
    if: |
      always() &&
      needs.changes.outputs.typescript == 'true' &&
      (needs.typescript-lint.result == 'success' || needs.typescript-lint.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node.js environment
        uses: ./.github/actions/setup-node-env

      - name: Run TypeScript tests
        run: pnpm test

      - name: Run type checking tests
        continue-on-error: true
        run: pnpm type-check:tests

  # ============================================================================
  # TIER 3: INTEGRATION TESTS (~45-90s each, run in parallel)
  # ============================================================================

  ruby-integration-simple:
    name: Ruby Integration (Simple Mode)
    timeout-minutes: 10
    runs-on: *runs-on
    needs: [changes, ruby-unit]
    if: &if-ruby-integration |
      always() &&
      needs.changes.outputs.ruby == 'true' &&
      needs.ruby-unit.result == 'success' &&
      !contains(needs.*.result, 'cancelled')

    services:
      redis: *valkey-service

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Ruby test environment
        uses: ./.github/actions/setup-ruby-test-env

      - name: Run Ruby tests
        uses: ./.github/actions/run-ruby-tests
        with:
          test-type: integration
          auth-mode: simple
          rspec-tag: simple_auth_mode
          rspec-paths: ${{ fromJSON(needs.changes.outputs.test-paths).ruby-integration-simple.rspec-paths }}
          tryouts-paths: ${{ fromJSON(needs.changes.outputs.test-paths).ruby-integration-simple.tryouts-paths }}
          results-file: 'rspec_simple_results.json'

  ruby-integration-full:
    name: Ruby Integration (Full Mode)
    timeout-minutes: 10
    runs-on: *runs-on
    needs: [changes, ruby-unit]
    if: *if-ruby-integration

    services:
      redis: *valkey-service

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Ruby test environment
        uses: ./.github/actions/setup-ruby-test-env

      - name: Run Ruby tests
        uses: ./.github/actions/run-ruby-tests
        with:
          test-type: integration
          auth-mode: full
          auth-database-url: 'sqlite::memory:'
          rspec-tag: full_auth_mode
          rspec-paths: ${{ fromJSON(needs.changes.outputs.test-paths).ruby-integration-full.rspec-paths }}
          tryouts-paths: ${{ fromJSON(needs.changes.outputs.test-paths).ruby-integration-full.tryouts-paths }}
          results-file: 'rspec_full_results.json'

  ruby-integration-disabled:
    name: Ruby Integration (Disabled Mode)
    timeout-minutes: 10
    runs-on: *runs-on
    needs: [changes, ruby-unit]
    if: *if-ruby-integration

    services:
      redis: *valkey-service

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Ruby test environment
        uses: ./.github/actions/setup-ruby-test-env

      - name: Run Ruby tests
        uses: ./.github/actions/run-ruby-tests
        with:
          test-type: integration
          auth-mode: disabled
          rspec-tag: disabled_auth_mode
          rspec-paths: ${{ fromJSON(needs.changes.outputs.test-paths).ruby-integration-disabled.rspec-paths }}
          tryouts-paths: ${{ fromJSON(needs.changes.outputs.test-paths).ruby-integration-disabled.tryouts-paths }}
          results-file: 'rspec_disabled_results.json'

  # ============================================================================
  # TIER 4: CONTAINER VALIDATION (~2-3 min)
  # ============================================================================

  check-oci-image:
    name: Container Validation
    timeout-minutes: 10
    runs-on: *runs-on
    needs:
      [
        changes,
        ruby-integration-simple,
        ruby-integration-full,
        ruby-integration-disabled,
        typescript-unit,
      ]
    if: |
      always() &&
      (needs.changes.outputs.oci == 'true' || needs.changes.outputs.frontend == 'true') &&
      (needs.ruby-integration-simple.result == 'success' || needs.ruby-integration-simple.result == 'skipped') &&
      (needs.ruby-integration-full.result == 'success' || needs.ruby-integration-full.result == 'skipped') &&
      (needs.ruby-integration-disabled.result == 'success' || needs.ruby-integration-disabled.result == 'skipped') &&
      (needs.typescript-unit.result == 'success' || needs.typescript-unit.result == 'skipped') &&
      !contains(needs.*.result, 'failure')

    services:
      redis: *valkey-service

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: public/web/dist/

      - name: Verify downloaded assets
        run: |
          if [ ! -d "public/web/dist" ] || [ -z "$(ls -A public/web/dist)" ]; then
            echo "::error::Frontend assets not found or empty!"
            exit 1
          fi
          echo "::notice::Frontend assets verified"

      - name: Build Container image
        run: docker build -t onetime-test .

      - name: Generate random secrets for container
        uses: ./.github/actions/generate-test-secrets

      - name: Start container
        run: |
          docker run -d \
            --name onetime-test-container \
            -p 3000:3000 \
            -e REDIS_URL=redis://host.docker.internal:2121/0 \
            -e SESSION_SECRET="${SESSION_SECRET}" \
            -e HMAC_SECRET="${HMAC_SECRET}" \
            -e SECRET="${SECRET}" \
            --add-host=host.docker.internal:host-gateway \
            onetime-test

      - name: Wait for service to be ready
        run: |
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            if curl -f -s -o /dev/null http://localhost:3000/; then
              echo "::notice::Service is ready!"
              exit 0
            fi
            sleep 2
          done
          echo "::error::Service failed to start"
          docker logs onetime-test-container
          exit 1

      - name: Test homepage loads
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/)
          if [ "$response" != "200" ]; then
            echo "::error::Homepage failed to load. HTTP status: $response"
            docker logs onetime-test-container
            exit 1
          fi
          echo "::notice::Homepage loaded successfully"

      - name: Cleanup
        if: always()
        run: |
          docker stop onetime-test-container || true
          docker rm onetime-test-container || true

  # ============================================================================
  # TIER 5: CI METRICS VALIDATION (runs last)
  # ============================================================================

  ci-metrics:
    name: CI Metrics
    runs-on: *runs-on
    timeout-minutes: 2
    # List ALL jobs to ensure this runs last (after all complete/skip/fail)
    needs:
      - changes
      - ruby-lint
      - typescript-lint
      - build-assets
      - ruby-unit
      - typescript-unit
      - ruby-integration-simple
      - ruby-integration-full
      - ruby-integration-disabled
      - check-oci-image
    # always() ensures this runs even if some jobs failed/skipped
    if: always()
    # Permissions for posting PR comments
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Fetch tier completion times from GitHub API
        id: timing
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # gh CLI is pre-installed on GitHub-hosted runners
          # GH_TOKEN provides authentication for API calls

          # Fetch workflow run start time (github.run_started_at doesn't exist in context)
          WORKFLOW_START=$(gh api "repos/${{ github.repository }}/actions/runs/${{ github.run_id }}" --jq '.run_started_at' 2>/dev/null)
          if [ -z "$WORKFLOW_START" ]; then
            echo "::warning::Failed to fetch workflow start time from API"
          fi
          echo "workflow_start=$WORKFLOW_START" >> $GITHUB_OUTPUT

          # Fetch job data for current workflow run
          if ! JOBS_JSON=$(gh api "repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs" --jq '.jobs' 2>/dev/null); then
            echo "::warning::Failed to fetch job data from API, metrics will show N/A"
            echo "tier1=" >> $GITHUB_OUTPUT
            echo "tier2=" >> $GITHUB_OUTPUT
            echo "tier3=" >> $GITHUB_OUTPUT
            echo "tier4=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Validate expected job names exist (warns if job names change)
          EXPECTED_JOBS=(
            "Ruby Lint"
            "TypeScript Lint"
            "Build Frontend Assets"
            "Ruby Unit Tests"
            "TypeScript Unit Tests"
            "Ruby Integration (Simple Mode)"
            "Ruby Integration (Full Mode)"
            "Ruby Integration (Disabled Mode)"
            "Container Validation"
          )
          ACTUAL_JOBS=$(echo "$JOBS_JSON" | jq -r '.[].name')
          for job in "${EXPECTED_JOBS[@]}"; do
            if ! echo "$ACTUAL_JOBS" | grep -qF "$job"; then
              echo "::warning::Expected job '$job' not found in workflow. Job names may have changed."
            fi
          done

          # Tier 1: Lint & Build - latest completion of all Tier 1 jobs
          # Jobs: "Ruby Lint", "TypeScript Lint", "Build Frontend Assets"
          TIER1_COMPLETE=$(echo "$JOBS_JSON" | jq -r '
            [.[] | select(
                .name == "Ruby Lint" or
                .name == "TypeScript Lint" or
                .name == "Build Frontend Assets"
              )
              | select(.completed_at != null) | .completed_at]
            | sort | last // empty
          ')

          # Tier 2: Unit Tests - latest completion of all Tier 2 jobs
          # Jobs: "Ruby Unit Tests", "TypeScript Unit Tests"
          TIER2_COMPLETE=$(echo "$JOBS_JSON" | jq -r '
            [.[] | select(
                .name == "Ruby Unit Tests" or
                .name == "TypeScript Unit Tests"
              )
              | select(.completed_at != null) | .completed_at]
            | sort | last // empty
          ')

          # Tier 3: Integration Tests - latest completion of all Tier 3 jobs
          # Jobs: "Ruby Integration (Simple Mode)", "Ruby Integration (Full Mode)",
          #       "Ruby Integration (Disabled Mode)"
          TIER3_COMPLETE=$(echo "$JOBS_JSON" | jq -r '
            [.[] | select(
                .name == "Ruby Integration (Simple Mode)" or
                .name == "Ruby Integration (Full Mode)" or
                .name == "Ruby Integration (Disabled Mode)"
              )
              | select(.completed_at != null) | .completed_at]
            | sort | last // empty
          ')

          # Tier 4: Container Validation
          # Jobs: "Container Validation"
          TIER4_COMPLETE=$(echo "$JOBS_JSON" | jq -r '
            [.[] | select(.name == "Container Validation")
              | select(.completed_at != null) | .completed_at]
            | first // empty
          ')

          echo "::debug::Tier 1 complete: $TIER1_COMPLETE"
          echo "::debug::Tier 2 complete: $TIER2_COMPLETE"
          echo "::debug::Tier 3 complete: $TIER3_COMPLETE"
          echo "::debug::Tier 4 complete: $TIER4_COMPLETE"

          echo "tier1=$TIER1_COMPLETE" >> $GITHUB_OUTPUT
          echo "tier2=$TIER2_COMPLETE" >> $GITHUB_OUTPUT
          echo "tier3=$TIER3_COMPLETE" >> $GITHUB_OUTPUT
          echo "tier4=$TIER4_COMPLETE" >> $GITHUB_OUTPUT

      - name: Check CI metrics
        uses: ./.github/actions/check-ci-metrics
        with:
          workflow-start-time: ${{ steps.timing.outputs.workflow_start }}
          tier1-complete-time: ${{ steps.timing.outputs.tier1 }}
          tier2-complete-time: ${{ steps.timing.outputs.tier2 }}
          tier3-complete-time: ${{ steps.timing.outputs.tier3 }}
          tier4-complete-time: ${{ steps.timing.outputs.tier4 }}
          # Override targets here if needed (defaults in action.yml):
          # target-tier1: '60'
          # target-tier2: '120'
          # target-tier3: '210'
          # target-tier4: '400'

      - name: Report job outcomes
        run: |
          echo "## Job Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Detect Changes | ${{ needs.changes.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ruby Lint | ${{ needs.ruby-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript Lint | ${{ needs.typescript-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Assets | ${{ needs.build-assets.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ruby Unit | ${{ needs.ruby-unit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript Unit | ${{ needs.typescript-unit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ruby Integration (Simple) | ${{ needs.ruby-integration-simple.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ruby Integration (Full) | ${{ needs.ruby-integration-full.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ruby Integration (Disabled) | ${{ needs.ruby-integration-disabled.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Validation | ${{ needs.check-oci-image.result }} |" >> $GITHUB_STEP_SUMMARY

      # Post CI metrics summary as PR comment (PRs only)
      - name: Post metrics to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const status = '${{ steps.check-ci-metrics.outputs.status || 'unknown' }}';

            // Build job results table
            const jobs = [
              { name: 'Detect Changes', result: '${{ needs.changes.result }}' },
              { name: 'Ruby Lint', result: '${{ needs.ruby-lint.result }}' },
              { name: 'TypeScript Lint', result: '${{ needs.typescript-lint.result }}' },
              { name: 'Build Assets', result: '${{ needs.build-assets.result }}' },
              { name: 'Ruby Unit', result: '${{ needs.ruby-unit.result }}' },
              { name: 'TypeScript Unit', result: '${{ needs.typescript-unit.result }}' },
              { name: 'Ruby Integration (Simple)', result: '${{ needs.ruby-integration-simple.result }}' },
              { name: 'Ruby Integration (Full)', result: '${{ needs.ruby-integration-full.result }}' },
              { name: 'Ruby Integration (Disabled)', result: '${{ needs.ruby-integration-disabled.result }}' },
              { name: 'Container Validation', result: '${{ needs.check-oci-image.result }}' },
            ];

            const statusIcon = (result) => {
              switch(result) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'skipped': return 'â­ï¸';
                case 'cancelled': return 'ðŸš«';
                default: return 'â“';
              }
            };

            const jobRows = jobs.map(j => `| ${j.name} | ${statusIcon(j.result)} ${j.result} |`).join('\n');

            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const comment = `## ðŸ“Š CI Metrics Summary

            | Job | Status |
            |-----|--------|
            ${jobRows}

            ---
            ðŸ”— [View full workflow run](${runUrl})
            `;

            // Find existing bot comment with this header
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('ðŸ“Š CI Metrics Summary')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }

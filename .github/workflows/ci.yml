# .github/workflows/ci.yml
# Refactored to use composite actions (Phase 5)

name: CI

# Main CI workflow that runs Ruby tests using RSpec and tryouts, plus TypeScript
# tests using Vitest and validation steps (linting, type-checking).
#
# Architecture (Phase 5 - Composite Actions):
# - Tier 0: Path filtering to skip irrelevant jobs
# - Tier 1: Lint jobs + build-assets (parallel, fast feedback)
# - Tier 2: Unit tests (ruby-unit, typescript-unit)
# - Tier 3: Integration tests by auth mode (parallel: simple, full, disabled)
# - Tier 4: Container validation uses pre-built assets
#
# Composite Actions:
# - setup-ruby-test-env: Ruby environment, artifacts, config, secrets
# - setup-node-env: Node.js, pnpm, caching
# - run-ruby-tests: Parameterized RSpec/Tryouts execution
#
# Path Filtering:
# - Ruby-only changes skip TypeScript jobs
# - TypeScript-only changes skip Ruby jobs
# - Workflow file changes (.github/**) run all jobs
# - Use [ci-all] in commit message to force all jobs
# - Use [ci-skip] in commit message to skip CI entirely

on:
  push:
    branches:
      - fix/*
      - rel/*
  pull_request:
    branches:
      - main
      - develop
      - feature/*
      - rel/*
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled'
        required: false
        default: false
      run_all:
        type: boolean
        description: 'Run all CI jobs (skip path filtering)'
        required: false
        default: false

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # TIER 0: PATH FILTERING (~5s)
  # ============================================================================

  changes:
    name: Detect Changes
    runs-on: &runs-on ubuntu-24.04
    timeout-minutes: 2
    outputs:
      ruby: ${{ steps.compute.outputs.ruby }}
      typescript: ${{ steps.compute.outputs.typescript }}
      frontend: ${{ steps.compute.outputs.frontend }}
      oci: ${{ steps.compute.outputs.oci }}
      ga_workflow_files: ${{ steps.compute.outputs.ga_workflow_files }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Check for CI flags
        id: check-flags
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -q '\[ci-skip\]'; then
            echo "skip_ci=true" >> $GITHUB_OUTPUT
          else
            echo "skip_ci=false" >> $GITHUB_OUTPUT
          fi
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.run_all }}" == "true" ]]; then
            echo "run_all=true" >> $GITHUB_OUTPUT
          elif echo "$COMMIT_MSG" | grep -q '\[ci-all\]'; then
            echo "run_all=true" >> $GITHUB_OUTPUT
          else
            echo "run_all=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect file changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            ruby:
              - '**/*.rb'
              - 'Gemfile'
              - 'Gemfile.lock'
              - '.rubocop.yml'
              - '.rubocop_todo.yml'
              - '.ruby-version'
              - '.rspec'
              - 'spec/**'
              - 'try/**'
              - 'apps/**'
              - 'lib/**'
              - 'bin/**'
              - 'config.ru'
            typescript:
              - 'src/**/*.ts'
              - 'src/**/*.vue'
              - 'src/**/*.tsx'
              - 'src/**/*.js'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'tsconfig.json'
              - 'tsconfig.*.json'
              - 'vite.config.ts'
              - 'vitest.config.ts'
              - 'tailwind.config.ts'
              - 'eslint.config.ts'
              - '.eslintrc*'
              - '.nvmrc'
              - '.node-version'
              - 'tests/**'
            frontend:
              - 'src/**'
              - 'public/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'vite.config.ts'
              - 'tailwind.config.ts'
              - 'postcss.config.*'
            oci:
              - 'Dockerfile*'
              - 'docker/**'
              - 'scripts/entrypoint.sh'
              - 'etc/**'
              - 'config.ru'
            ga_workflow_files:
              - '.github/workflows/**'
              - '.github/actions/**'

      - name: Compute final outputs
        id: compute
        run: |
          SKIP_CI="${{ steps.check-flags.outputs.skip_ci }}"
          RUN_ALL="${{ steps.check-flags.outputs.run_all }}"
          GA_WORKFLOWS="${{ steps.filter.outputs.ga_workflow_files }}"

          if [[ "$SKIP_CI" == "true" ]]; then
            echo "ruby=false" >> $GITHUB_OUTPUT
            echo "typescript=false" >> $GITHUB_OUTPUT
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "oci=false" >> $GITHUB_OUTPUT
            echo "ga_workflow_files=false" >> $GITHUB_OUTPUT
          elif [[ "$RUN_ALL" == "true" || "$GA_WORKFLOWS" == "true" ]]; then
            echo "ruby=true" >> $GITHUB_OUTPUT
            echo "typescript=true" >> $GITHUB_OUTPUT
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "oci=true" >> $GITHUB_OUTPUT
            echo "ga_workflow_files=true" >> $GITHUB_OUTPUT
          else
            echo "ruby=${{ steps.filter.outputs.ruby }}" >> $GITHUB_OUTPUT
            echo "typescript=${{ steps.filter.outputs.typescript }}" >> $GITHUB_OUTPUT
            echo "frontend=${{ steps.filter.outputs.frontend }}" >> $GITHUB_OUTPUT
            echo "oci=${{ steps.filter.outputs.oci }}" >> $GITHUB_OUTPUT
            echo "ga_workflow_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate job summary
        run: |
          echo "## Path Filter Results" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Final |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ruby | ${{ steps.compute.outputs.ruby }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ steps.compute.outputs.typescript }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.compute.outputs.frontend }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OCI | ${{ steps.compute.outputs.oci }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # TIER 1: LINT & BUILD JOBS (~30-45s)
  # ============================================================================

  ruby-lint:
    name: Ruby Lint
    timeout-minutes: 5
    runs-on: *runs-on
    needs: [changes]
    if: needs.changes.outputs.ruby == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - uses: ruby/setup-ruby@ab177d40ee5483edb974554986f56b33477e21d0
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Run Rubocop
        run: |
          mkdir -p tmp
          bundle exec rubocop --config .rubocop.yml \
            --format progress \
            --format json --out tmp/rubocop_results.json \
            --fail-level warning

      - name: Upload Rubocop results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rubocop-results
          path: tmp/rubocop_results.json
          retention-days: 7

  typescript-lint:
    name: TypeScript Lint
    timeout-minutes: 5
    runs-on: *runs-on
    needs: [changes]
    if: needs.changes.outputs.typescript == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node.js environment
        uses: ./.github/actions/setup-node-env

      - name: Run type checking
        run: pnpm type-check

      - name: Run linting
        run: pnpm lint

  build-assets:
    name: Build Frontend Assets
    timeout-minutes: 10
    runs-on: *runs-on
    needs: [changes]
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.ruby == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node.js environment
        uses: ./.github/actions/setup-node-env

      - name: Build assets
        run: pnpm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: public/web/dist/
          retention-days: 1
          if-no-files-found: error

  # ============================================================================
  # TIER 2: UNIT TESTS (~30-45s)
  # ============================================================================

  ruby-unit:
    name: Ruby Unit Tests
    timeout-minutes: 10
    runs-on: *runs-on
    needs: [changes, ruby-lint, build-assets]
    if: |
      always() &&
      needs.changes.outputs.ruby == 'true' &&
      (needs.ruby-lint.result == 'success' || needs.ruby-lint.result == 'skipped') &&
      (needs.build-assets.result == 'success' || needs.build-assets.result == 'skipped')

    services:
      redis: &valkey-service
        image: ghcr.io/valkey-io/valkey:8.1.3-bookworm@sha256:fea8b3e67b15729d4bb70589eb03367bab9ad1ee89c876f54327fc7c6e618571
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 5
          --memory=4g
        ports:
          - 2121:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Ruby test environment
        uses: ./.github/actions/setup-ruby-test-env

      - name: Run Ruby tests
        uses: ./.github/actions/run-ruby-tests
        with:
          test-type: unit
          auth-mode: simple
          tryouts-paths: 'try/unit try/system'
          rspec-paths: 'spec/onetime spec/lib spec/api spec/cli'
          results-file: 'rspec_unit_results.json'
          debug-enabled: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}

  typescript-unit:
    name: TypeScript Unit Tests
    timeout-minutes: 15
    runs-on: *runs-on
    needs: [changes, typescript-lint]
    if: |
      always() &&
      needs.changes.outputs.typescript == 'true' &&
      (needs.typescript-lint.result == 'success' || needs.typescript-lint.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node.js environment
        uses: ./.github/actions/setup-node-env

      - name: Run TypeScript tests
        run: pnpm test

      - name: Run type checking tests
        continue-on-error: true
        run: pnpm type-check:tests

  # ============================================================================
  # TIER 3: INTEGRATION TESTS (~45-90s each, run in parallel)
  # ============================================================================

  ruby-integration-simple:
    name: Ruby Integration (Simple Mode)
    timeout-minutes: 10
    runs-on: *runs-on
    needs: [changes, ruby-unit]
    if: &if-ruby-integration |
      always() &&
      needs.changes.outputs.ruby == 'true' &&
      needs.ruby-unit.result == 'success' &&
      !contains(needs.*.result, 'cancelled')

    services:
      redis: *valkey-service

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Ruby test environment
        uses: ./.github/actions/setup-ruby-test-env

      - name: Run Ruby tests
        uses: ./.github/actions/run-ruby-tests
        with:
          test-type: integration
          auth-mode: simple
          rspec-tag: simple_auth_mode
          rspec-paths: 'spec/integration'
          tryouts-paths: 'try/integration/middleware try/integration/boot try/integration/web try/integration/api try/integration/email try/integration/billing try/integration/homepage_bypass_header_integration_try.rb try/integration/homepage_mode_integration_try.rb'
          results-file: 'rspec_simple_results.json'

  ruby-integration-full:
    name: Ruby Integration (Full Mode)
    timeout-minutes: 10
    runs-on: *runs-on
    needs: [changes, ruby-unit]
    if: *if-ruby-integration

    services:
      redis: *valkey-service

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Ruby test environment
        uses: ./.github/actions/setup-ruby-test-env

      - name: Run Ruby tests
        uses: ./.github/actions/run-ruby-tests
        with:
          test-type: integration
          auth-mode: full
          auth-database-url: 'sqlite::memory:'
          rspec-tag: full_auth_mode
          rspec-paths: 'spec/integration'
          results-file: 'rspec_full_results.json'

  ruby-integration-disabled:
    name: Ruby Integration (Disabled Mode)
    timeout-minutes: 10
    runs-on: *runs-on
    needs: [changes, ruby-unit]
    if: *if-ruby-integration

    services:
      redis: *valkey-service

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Ruby test environment
        uses: ./.github/actions/setup-ruby-test-env

      - name: Run Ruby tests
        uses: ./.github/actions/run-ruby-tests
        with:
          test-type: integration
          auth-mode: disabled
          rspec-tag: disabled_auth_mode
          rspec-paths: 'spec/integration'
          results-file: 'rspec_disabled_results.json'

  # ============================================================================
  # TIER 4: CONTAINER VALIDATION (~2-3 min)
  # ============================================================================

  check-oci-image:
    name: Container Validation
    timeout-minutes: 10
    runs-on: *runs-on
    needs:
      [
        changes,
        ruby-integration-simple,
        ruby-integration-full,
        ruby-integration-disabled,
        typescript-unit,
      ]
    if: |
      always() &&
      (needs.changes.outputs.oci == 'true' || needs.changes.outputs.frontend == 'true') &&
      (needs.ruby-integration-simple.result == 'success' || needs.ruby-integration-simple.result == 'skipped') &&
      (needs.ruby-integration-full.result == 'success' || needs.ruby-integration-full.result == 'skipped') &&
      (needs.ruby-integration-disabled.result == 'success' || needs.ruby-integration-disabled.result == 'skipped') &&
      (needs.typescript-unit.result == 'success' || needs.typescript-unit.result == 'skipped') &&
      !contains(needs.*.result, 'failure')

    services:
      redis: *valkey-service

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: public/web/dist/

      - name: Verify downloaded assets
        run: |
          if [ ! -d "public/web/dist" ] || [ -z "$(ls -A public/web/dist)" ]; then
            echo "::error::Frontend assets not found or empty!"
            exit 1
          fi
          echo "::notice::Frontend assets verified"

      - name: Build Container image
        run: docker build -t onetime-test .

      - name: Generate random secrets for container
        uses: ./.github/actions/generate-test-secrets

      - name: Start container
        run: |
          docker run -d \
            --name onetime-test-container \
            -p 3000:3000 \
            -e REDIS_URL=redis://host.docker.internal:2121/0 \
            -e SESSION_SECRET="${SESSION_SECRET}" \
            -e HMAC_SECRET="${HMAC_SECRET}" \
            -e SECRET="${SECRET}" \
            --add-host=host.docker.internal:host-gateway \
            onetime-test

      - name: Wait for service to be ready
        run: |
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            if curl -f -s -o /dev/null http://localhost:3000/; then
              echo "::notice::Service is ready!"
              exit 0
            fi
            sleep 2
          done
          echo "::error::Service failed to start"
          docker logs onetime-test-container
          exit 1

      - name: Test homepage loads
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/)
          if [ "$response" != "200" ]; then
            echo "::error::Homepage failed to load. HTTP status: $response"
            docker logs onetime-test-container
            exit 1
          fi
          echo "::notice::Homepage loaded successfully"

      - name: Cleanup
        if: always()
        run: |
          docker stop onetime-test-container || true
          docker rm onetime-test-container || true

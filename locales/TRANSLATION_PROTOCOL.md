# Translation Session Protocol

Branch: `feature/2319-workflow-historical`
Issue: #2319

## Philosophy

**"Excel first"** - We deliberately keep this workflow manual and conversational. No automation until the process is proven. The scripts are helpers, not a pipeline. Once we know exactly what works, we can build tooling.

## Core Concepts

### Task = One JSON Level
A task is all sibling keys sharing a parent path. For example, `web.COMMON.buttons.submit` and `web.COMMON.buttons.cancel` form one task under `web.COMMON.buttons`.

**Why:**
- Correlated strings translated together for consistency
- Natural batch size, self-limiting by design
- Forces good locale file organization (if a level is too large, restructure it)

### Glossary
Captures terminology decisions as we translate. When we decide "secret" → "sekreto" in Esperanto, that goes in the glossary so future sessions stay consistent.

### Export Guides
Locale-specific translation guidance in `locales/guides/exports/{locale}.md`. Read once per session to establish context. Mature locales (de, fr) have detailed guides; new locales (eo) build them as we go.

### Handoff
To continue work in a new session, generate a handoff document that preserves key decisions and context. Use `/handoff` or write one manually.

## Architecture

- **Task = one JSON level** - sibling keys grouped by parent path
- **SQLite is working state** - translations live in `locales/db/tasks.db` until synced
- **locales/content/ is source of truth** - `locales/content/{locale}/*.json` (flat format with `text` field)
- **generated/locales/ is app-consumable** - merged nested JSON for vue-i18n (auto-generated by frontend on startup)

## Starting a Translation Session

Begin a new Claude conversation with only this file for context:

```
@locales/TRANSLATION_PROTOCOL.md

Let's do a short translation session for [LOCALE]. Claim the next task and propose translations.
```

Replace `[LOCALE]` with the target locale code (e.g., `eo`, `fr_CA`, `de`).

## Session Workflow

### 0. Generate level tasks (if not already done)
```bash
python locales/scripts/generate_tasks.py eo --levels
```
This populates the `level_tasks` table required by `get_next_task.py`. Run once per locale, or re-run to refresh after English source changes.

The `--levels` flag groups sibling keys by their parent path (e.g., all keys under `web.COMMON.buttons`). This keeps work productive by batching related strings together rather than handling thousands of individual keys. Translators get more context since messages at the same level are usually related. It also incentivizes keeping levels reasonably sized - if a level grows too large, it's a signal to restructure.

### 1. Check status
```bash
python locales/scripts/get_next_task.py eo --stats
```

### 2. Claim next task
```bash
python locales/scripts/get_next_task.py eo --claim
```
Outputs formatted table with Key, English, Esperanto columns.

### 3. Review proposed translations
Assistant proposes translations. Respond with:
- **A** - Accept (runs update_task.py)
- **S** - Skip (marks skipped, moves to next)
- **R** - Revisit (marks pending, moves to next)
- **Q** - Quit session

### 4. On accept, update task
```bash
python locales/scripts/update_task.py TASK_ID '{"key": "translation", ...}'
```

### 5. Record glossary decisions
```bash
python locales/scripts/db.py query "INSERT INTO glossary (locale, term, translation, notes) VALUES ('eo', 'secret', 'sekreto', 'core concept')"
```

### 6. End session - export to content
```bash
python locales/scripts/export_to_historical.py eo
```
The frontend auto-generates `generated/locales/` on startup from `locales/content/`.

### 7. Commit
```bash
git add locales/content/eo/
git commit -m "[#2319] Add eo translations from session"
```

## Task Output Format

Title: `**Task 8** · _common.json · web.TITLES · 44 keys`

Table columns:
- Key (28 chars, right-aligned)
- English (60 chars, wrapped)
- Esperanto (60 chars, wrapped)

Sorted by English text length.

## Translation Notes Guidelines

- Include English source text with every proposal
- Compare to similar translations in other languages when relevant
- Note connotations (e.g., "secret" = personal vs confidential)
- Preserve `{placeholders}` exactly

## Key Files

```
locales/scripts/
  generate_tasks.py   # --levels populates level_tasks for workflow
  get_next_task.py    # --claim, --filter, --stats, --id
  update_task.py      # TASK_ID '{"key": "val"}'
  export_to_historical.py  # SQLite -> locales/content/
  sync_to_src.py      # manual sync (frontend auto-generates on startup)
  db.py               # migrate, hydrate, query

locales/db/
  schema.sql          # table definitions
  tasks.db            # SQLite database (not in git)

locales/content/{locale}/  # source of truth (flat JSON with text field)
generated/locales/         # app-consumable JSON (auto-generated by frontend)
```

## Database Tables

- `level_tasks` - translation tasks grouped by JSON level
- `glossary` - terminology decisions per locale
- `session_log` - session records with verbatim notes
- `schema_migrations` - applied schema versions

## Esperanto Status

Run `python locales/scripts/get_next_task.py eo --stats` to check current progress.

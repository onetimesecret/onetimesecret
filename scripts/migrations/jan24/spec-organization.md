# Organization Model Migration Spec (V1 → V2)

## Key Pattern

| Aspect | V1 | V2 |
|--------|----|----|
| Prefix | `organization` | `organization` |
| Key Pattern | `organization:{objid}:object` | `organization:{objid}:object` |
| Identifier | `objid` (UUID) | `objid` (UUID) |
| External ID | `on%<id>s` (e.g., `onABC123`) | `on%<id>s` |

**Note:** Organization is conceptually NEW in V2 - created 1:1 from Customer records during migration.

---

## Field Mapping

### Core Fields (Created from Customer)

| Field | Source | Transform |
|-------|--------|-----------|
| `objid` | Generated | New UUID for organization |
| `extid` | Generated | Format: `on{short_id}` |
| `display_name` | Customer email domain or name | Derived |
| `description` | Empty | Initialize empty |
| `owner_id` | Customer.objid | Direct reference |
| `contact_email` | Customer.email | Copy |
| `is_default` | `true` | Migrated orgs are default |

### Billing Fields (Transferred from Customer)

| V1 Customer Field | V2 Organization Field |
|-------------------|----------------------|
| `stripe_customer_id` | `stripe_customer_id` |
| `stripe_subscription_id` | `stripe_subscription_id` |
| `planid` | `planid` |
| (new) | `billing_email` |
| (new) | `subscription_status` |
| (new) | `subscription_period_end` |
| (new) | `stripe_checkout_email` |

### New V2 Fields (Migration-Only)

| Field | Type | Purpose | Post-Migration |
|-------|------|---------|----------------|
| `caboose` | JsonKey | Migration metadata + payment link info | KEEP |
| `v1_identifier` | String | Original key reference | REMOVE later |
| `migration_status` | String | pending/completed/failed | REMOVE later |
| `migrated_at` | String | Migration timestamp | REMOVE later |
| `_original_record` | JsonKey | Source customer data snapshot | REMOVE later |
| `v1_source_custid` | String | Source customer email | REMOVE later |

---

## Redis Data Types

| Type | Key Pattern | Notes |
|------|-------------|-------|
| Hash (main) | `organization:{objid}:object` | Primary object data |
| Hash | `organization:{objid}:urls` | URL configuration |
| Sorted Set | `organization:{objid}:pending_invitations` | Pending member invites |
| JsonKey | `organization:{objid}:caboose` | V2 - payment links, metadata |
| JsonKey | `organization:{objid}:_original_record` | V2 - migration snapshot |

---

## Indexes to Create

### Instance Index

**New model.** Must be populated during migration as organizations are created.

```redis
ZADD organization:instances <created_timestamp> <objid>
```

### Lookup Indexes

| Index | Key | Type | Content |
|-------|-----|------|---------|
| Contact Email | `organization:contact_email_index` | Hash | `email` → `"objid"` |
| Stripe Customer | `organization:stripe_customer_id_index` | Hash | `cus_xxx` → `"objid"` |
| Stripe Subscription | `organization:stripe_subscription_id_index` | Hash | `sub_xxx` → `"objid"` |
| Stripe Checkout Email | `organization:stripe_checkout_email_index` | Hash | `email` → `"objid"` |
| ExtID | `organization:extid_lookup` | Hash | `extid` → `"objid"` |
| ObjID | `organization:objid_lookup` | Hash | `objid` → `"objid"` |

### Relationship Collections (Auto-Generated by `participates_in`)

| Collection | Key Pattern | Type | Content |
|------------|-------------|------|---------|
| Members | `organization:{objid}:members` | Sorted Set | Customer objids (score: joined timestamp) |
| Domains | `organization:{objid}:domains` | Sorted Set | CustomDomain objids (score: created) |
| Receipts | `organization:{objid}:receipts` | Sorted Set | Receipt objids (score: created) |

---

## Migration Transform Steps

```ruby
def create_org_from_customer(customer)
  org_objid = Familia.generate_id

  {
    objid: org_objid,
    extid: "on#{org_objid[0..7]}",
    display_name: derive_display_name(customer.email),
    description: '',
    owner_id: customer.objid,
    contact_email: customer.email,
    is_default: 'true',

    # Transfer billing from customer
    stripe_customer_id: customer.stripe_customer_id,
    stripe_subscription_id: customer.stripe_subscription_id,
    planid: customer.planid,
    billing_email: customer.email,

    # Migration tracking
    v1_source_custid: customer.email,
    v1_identifier: "customer:#{customer.objid}",
    migration_status: 'completed',
    migrated_at: Time.now.to_f.to_s,
    _original_record: customer.to_json
  }
end
```

### Index Rebuild

```ruby
def rebuild_organization_indexes(org)
  objid = org.objid
  created = org.created.to_f

  # Instance tracking
  redis.zadd('organization:instances', created, objid)

  # Lookup indexes (JSON-quoted values)
  redis.hset('organization:contact_email_index', org.contact_email, objid.to_json)
  redis.hset('organization:extid_lookup', org.extid, objid.to_json)
  redis.hset('organization:objid_lookup', objid, objid.to_json)

  # Stripe indexes (only if present)
  if org.stripe_customer_id&.start_with?('cus_')
    redis.hset('organization:stripe_customer_id_index', org.stripe_customer_id, objid.to_json)
  end
  if org.stripe_subscription_id&.start_with?('sub_')
    redis.hset('organization:stripe_subscription_id_index', org.stripe_subscription_id, objid.to_json)
  end

  # Add owner as first member
  redis.zadd("organization:#{objid}:members", created, org.owner_id)
end
```

---

## Validation Checklist

- [ ] Organization created with valid objid
- [ ] extid generated in `on{id}` format
- [ ] owner_id references valid Customer
- [ ] contact_email set from customer email
- [ ] Stripe billing fields transferred from customer
- [ ] is_default = true for migrated orgs
- [ ] Added to `organization:instances`
- [ ] Added to `organization:contact_email_index`
- [ ] Added to `organization:extid_lookup`
- [ ] Added to `organization:objid_lookup`
- [ ] Stripe indexes populated if applicable
- [ ] Owner added to `organization:{objid}:members`
- [ ] Migration status = 'completed'

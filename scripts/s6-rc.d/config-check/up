#!/command/execlineb -P

foreground { s6-echo "[config-check] Validating configuration..." }

# Check for v0.24.0 migration requirement
if { test -f etc/config.yaml }
if { test -f migrate/20250727-1523_standardize_config_symbols_to_strings.rb }

# Check if migration is needed
backtick -n NEEDS_MIGRATION {
  pipeline { s6-cat etc/config.yaml }
  grep -q "^[[:space:]]*:[a-zA-Z_][a-zA-Z0-9_]*:"
}

importas -u NEEDS_MIGRATION NEEDS_MIGRATION
ifelse { test -n "${NEEDS_MIGRATION}" } {
  foreground { s6-echo "[config-check] ✗ ERROR: Migration required for v0.24.0" }
  foreground { s6-echo "[config-check] Run: bin/ots migrate 20250727-1523_standardize_config_symbols_to_strings.rb --run" }
  exit 1
}

foreground { s6-echo "[config-check] ✓ Configuration valid" }
exit 0

# Familia 2 Migration - Remaining Changes
# Generated on 2025-08-08 21:36:49 -0700
# Total changes: 115

--- a/apps/api/v1/controllers/class_methods.rb
+++ b/apps/api/v1/controllers/class_methods.rb
@@ -90,1 +90,1 @@
-          'ttl' => metadata_ttl, # static value from redis hash field
+          'ttl' => metadata_ttl, # static value from database hash field

--- a/apps/api/v1/controllers/helpers.rb
+++ b/apps/api/v1/controllers/helpers.rb
@@ -87,1 +87,1 @@
-      # Track attempts to save non-string data to Redis as a warning error
+      # Track attempts to save non-string data to the database as a warning error
@@ -333,1 +333,1 @@
-      # Load from redis or create the session
+      # Load from the database or create the session

--- a/apps/api/v1/models/custom_domain.rb
+++ b/apps/api/v1/models/custom_domain.rb
@@ -198,1 +198,1 @@
-        # not save it to Redis. We do that here to piggyback on the inital
+        # not save it to the database. We do that here to piggyback on the inital
@@ -200,1 +200,1 @@
-        # the object from Redis using
+        # the object from the database using

--- a/apps/api/v1/models/session.rb
+++ b/apps/api/v1/models/session.rb
@@ -93,1 +93,1 @@
-      # Remove the existing session key from Redis
+      # Remove the existing session key from the database

--- a/apps/api/v2/controllers/helpers.rb
+++ b/apps/api/v2/controllers/helpers.rb
@@ -84,1 +84,1 @@
-      # Track attempts to save non-string data to Redis as a warning error
+      # Track attempts to save non-string data to the database as a warning error
@@ -185,1 +185,1 @@
-      # Load from redis or create the session
+      # Load from the database or create the session

--- a/apps/api/v2/models/custom_domain.rb
+++ b/apps/api/v2/models/custom_domain.rb
@@ -109,1 +109,1 @@
-    # Removes all Redis keys associated with this custom domain.
+    # Removes all database keys associated with this custom domain.
@@ -112,1 +112,1 @@
-    # - The main Redis key for the custom domain (`self.dbkey`)
+    # - The main database key for the custom domain (`self.dbkey`)
@@ -113,1 +113,1 @@
-    # - Redis keys of all related objects specified in `self.class.data_types`
+    # - database keys of all related objects specified in `self.class.data_types`
@@ -132,1 +132,1 @@
-        # Append related Redis keys to the deletion list.
+        # Append related database keys to the deletion list.

--- a/apps/api/v2/models/definitions/customer_definition.rb
+++ b/apps/api/v2/models/definitions/customer_definition.rb
@@ -27,1 +27,1 @@
-    identifier :custid
+    identifier_field :custid

--- a/apps/api/v2/models/definitions/metadata_definition.rb
+++ b/apps/api/v2/models/definitions/metadata_definition.rb
@@ -8,1 +8,1 @@
-    ttl 14.days
+    default_expiration 14.days
@@ -11,1 +11,1 @@
-    identifier :generate_id
+    identifier_field :generate_id

--- a/apps/api/v2/models/definitions/organization_definition.rb
+++ b/apps/api/v2/models/definitions/organization_definition.rb
@@ -15,1 +15,1 @@
-    identifier :orgid
+    identifier_field :orgid

--- a/apps/api/v2/models/definitions/secret_definition.rb
+++ b/apps/api/v2/models/definitions/secret_definition.rb
@@ -11,1 +11,1 @@
-    identifier :generate_id
+    identifier_field :generate_id
@@ -32,1 +32,1 @@
-    counter :view_count, ttl: 14.days # out lives the secret itself
+    counter :view_count, default_expiration: 14.days # out lives the secret itself

--- a/apps/api/v2/models/definitions/team_definition.rb
+++ b/apps/api/v2/models/definitions/team_definition.rb
@@ -9,1 +9,1 @@
-    identifier :teamid
+    identifier_field :teamid

--- a/apps/api/v2/models/management/custom_domain_management.rb
+++ b/apps/api/v2/models/management/custom_domain_management.rb
@@ -45,1 +45,1 @@
-            # Create minimal customer instance for Redis key
+            # Create minimal customer instance for database key
@@ -143,1 +143,1 @@
-        # not save it to Redis. We do that here to piggyback on the inital
+        # not save it to the database. We do that here to piggyback on the inital
@@ -145,1 +145,1 @@
-        # the object from Redis using
+        # the object from the database using

--- a/apps/api/v2/models/management/session_management.rb
+++ b/apps/api/v2/models/management/session_management.rb
@@ -9,1 +9,1 @@
-      # The session is immediately saved to Redis and added to the class-level
+      # The session is immediately saved to the database and added to the class-level
@@ -24,1 +24,1 @@
-      # Unlike #create, this session is not saved to Redis or tracked in the class
+      # Unlike #create, this session is not saved to the database or tracked in the class

--- a/apps/api/v2/models/session.rb
+++ b/apps/api/v2/models/session.rb
@@ -40,1 +40,1 @@
-      # Remove the existing session key from Redis
+      # Remove the existing session key from the database

--- a/apps/api/v2/models/system_settings.rb
+++ b/apps/api/v2/models/system_settings.rb
@@ -68,1 +68,1 @@
-    identifier :configid
+    identifier_field :configid
@@ -218,1 +218,1 @@
-        redis.watch(obj.rediskey) do
+        redis.watch(obj.dbkey) do
@@ -221,1 +221,1 @@
-            raise Onetime::Problem, "Duplicate record #{obj.rediskey}"
+            raise Onetime::Problem, "Duplicate record #{obj.dbkey}"
@@ -229,1 +229,1 @@
-              multi.hset(obj.rediskey, key, serialized_value) if serialized_value
+              multi.hset(obj.dbkey, key, serialized_value) if serialized_value
@@ -231,1 +231,1 @@
-            multi.hset(obj.rediskey, :configid, obj.identifier)
+            multi.hset(obj.dbkey, :configid, obj.identifier)
@@ -232,1 +232,1 @@
-            multi.hset(obj.rediskey, :created_at, Time.now.to_i)
+            multi.hset(obj.dbkey, :created_at, Time.now.to_i)
@@ -233,1 +233,1 @@
-            multi.hset(obj.rediskey, :updated_at, Time.now.to_i)
+            multi.hset(obj.dbkey, :updated_at, Time.now.to_i)
@@ -247,1 +247,1 @@
-        # not save it to Redis. We do that here to piggyback on the inital
+        # not save it to the database. We do that here to piggyback on the inital
@@ -249,1 +249,1 @@
-        # the object from Redis using
+        # the object from the database using
@@ -264,1 +264,1 @@
-          multi.zadd(values.rediskey, now, fobj.to_s)
+          multi.zadd(values.dbkey, now, fobj.to_s)
@@ -265,1 +265,1 @@
-          multi.zadd(stack.rediskey, now, fobj.to_s)
+          multi.zadd(stack.dbkey, now, fobj.to_s)
@@ -266,1 +266,1 @@
-          multi.zadd(audit_log.rediskey, now, fobj.to_s)
+          multi.zadd(audit_log.dbkey, now, fobj.to_s)
@@ -320,1 +320,1 @@
-            multi.zpopmax(stack.rediskey, 1).first&.first
+            multi.zpopmax(stack.dbkey, 1).first&.first

--- a/apps/web/core/controllers/helpers.rb
+++ b/apps/web/core/controllers/helpers.rb
@@ -85,1 +85,1 @@
-      # Track attempts to save non-string data to Redis as a warning error
+      # Track attempts to save non-string data to the database as a warning error
@@ -331,1 +331,1 @@
-      # Load from redis or create the session
+      # Load from the database or create the session

--- a/lib/onetime/boot.rb
+++ b/lib/onetime/boot.rb
@@ -103,1 +103,1 @@
-      OT.le "Cannot connect to redis #{Familia.uri} (#{ex.class})"
+      OT.le "Cannot connect to the database #{Familia.uri} (#{ex.class})"

--- a/lib/onetime/cli/change_email_command.rb
+++ b/lib/onetime/cli/change_email_command.rb
@@ -14,1 +14,1 @@
-      # Connect to Redis DB 0 where audit logs are stored
+      # Connect to the database DB 0 where audit logs are stored
@@ -15,1 +15,1 @@
-      redis = Familia.redis
+      redis = Familia.dbclient
@@ -172,1 +172,1 @@
-                  current_domain_id = V2::CustomDomain.redis.hget('customdomain:display_domains', domain)
+                  current_domain_id = V2::CustomDomain.dbclient.hget('customdomain:display_domains', domain)
@@ -192,1 +192,1 @@
-              # Save report to Redis for permanent audit trail
+              # Save report to the database for permanent audit trail
@@ -193,1 +193,1 @@
-              report_key = service.save_report_to_redis
+              report_key = service.save_report_serialize_value
@@ -195,1 +195,1 @@
-              puts "Email change completed and logged to Redis with key: #{report_key}"
+              puts "Email change completed and logged to the database with key: #{report_key}"
@@ -208,1 +208,1 @@
-        puts 'this may indicate data corruption or manual changes to Redis keys.'
+        puts 'this may indicate data corruption or manual changes to database keys.'
@@ -215,1 +215,1 @@
-    # Helper method to fetch a specific email change report from Redis
+    # Helper method to fetch a specific email change report from the database
@@ -216,1 +216,1 @@
-    # @param key [String] The Redis key for the report
+    # @param key [String] The database key for the report
@@ -219,1 +219,1 @@
-      redis = Familia.redis
+      redis = Familia.dbclient

--- a/lib/onetime/initializers/check_global_banner.rb
+++ b/lib/onetime/initializers/check_global_banner.rb
@@ -8,1 +8,1 @@
-      @global_banner = Familia.redis(0).get('global_banner')
+      @global_banner = Familia.dbclient(0).get('global_banner')

--- a/lib/onetime/initializers/connect_databases.rb
+++ b/lib/onetime/initializers/connect_databases.rb
@@ -42,1 +42,1 @@
-        model_class.redis = Familia.redis(db_index)
+        model_class.dbclient = Familia.dbclient(db_index)
@@ -43,1 +43,1 @@
-        ping_result       = model_class.redis.ping
+        ping_result       = model_class.dbclient.ping

--- a/lib/onetime/initializers/print_log_banner.rb
+++ b/lib/onetime/initializers/print_log_banner.rb
@@ -31,1 +31,1 @@
-      redis_info   = Familia.redis.info
+      redis_info   = Familia.dbclient.info

--- a/lib/onetime/migration/model_migration.rb
+++ b/lib/onetime/migration/model_migration.rb
@@ -33,1 +33,1 @@
-  # - {#load_from_key} - Custom object loading from Redis keys
+  # - {#load_from_key} - Custom object loading from database keys
@@ -149,1 +149,1 @@
-    # Load Familia::Horreum object instance from Redis key
+    # Load Familia::Horreum object instance from database key
@@ -159,1 +159,1 @@
-    # @param key [String] Redis key to load from
+    # @param key [String] database key to load from
@@ -352,1 +352,1 @@
-      error("Cannot connect to Redis: #{ex.message}")
+      error("Cannot connect to the database: #{ex.message}")

--- a/lib/onetime/migration/pipeline_migration.rb
+++ b/lib/onetime/migration/pipeline_migration.rb
@@ -73,1 +73,1 @@
-    #   The original Redis key is preserved because records with missing/empty
+    #   The original database key is preserved because records with missing/empty
@@ -74,1 +74,1 @@
-    #   identifier fields cannot reconstitute their Redis key via obj.dbkey.
+    #   identifier fields cannot reconstitute their database key via obj.dbkey.
@@ -195,1 +195,1 @@
-    # @param original_key [String] original Redis key from SCAN
+    # @param original_key [String] original database key from SCAN

--- a/lib/onetime/services/change_email.rb
+++ b/lib/onetime/services/change_email.rb
@@ -8,1 +8,1 @@
-    # which involves updating multiple Redis keys and maintaining relationships
+    # which involves updating multiple database keys and maintaining relationships
@@ -13,1 +13,1 @@
-    # 2. Redis keys associated with the customer (object, custom_domain, metadata)
+    # 2. database keys associated with the customer (object, custom_domain, metadata)
@@ -56,1 +56,1 @@
-                   '2. Update the following Redis keys:',
+                   '2. Update the following database keys:',
@@ -133,1 +133,1 @@
-          display_domains_id = V2::CustomDomain.redis.hget('customdomain:display_domains', domain)
+          display_domains_id = V2::CustomDomain.dbclient.hget('customdomain:display_domains', domain)
@@ -142,1 +142,1 @@
-      # Executes the email change process by updating customer-related Redis keys.
+      # Executes the email change process by updating customer-related database keys.
@@ -146,1 +146,1 @@
-      # 2. Renames all Redis keys associated with the customer
+      # 2. Renames all database keys associated with the customer
@@ -156,1 +156,1 @@
-        redis = V2::Customer.redis
+        redis = V2::Customer.dbclient
@@ -235,1 +235,1 @@
-      # This report is saved to Redis DB 0 for audit purposes.
+      # This report is saved to the database DB 0 for audit purposes.
@@ -252,1 +252,1 @@
-      # Saves the report to Redis DB 0 for auditing purposes
+      # Saves the report to the database DB 0 for auditing purposes
@@ -254,1 +254,1 @@
-      def save_report_to_redis
+      def save_report_serialize_value
@@ -259,1 +259,1 @@
-        # Save to Redis DB 0 for audit logs
+        # Save to the database DB 0 for audit logs
@@ -260,1 +260,1 @@
-        redis = Familia.redis
+        redis = Familia.dbclient
@@ -264,1 +264,1 @@
-        log "Report saved to Redis with key: #{report_key}", true
+        log "Report saved to the database with key: #{report_key}", true

--- a/migrate/archive/1002_planid_audit.rb
+++ b/migrate/archive/1002_planid_audit.rb
@@ -46,1 +46,1 @@
-          # Get planid directly from Redis hash
+          # Get planid directly from database hash

--- a/migrate/archive/1381_customer_field.rb
+++ b/migrate/archive/1381_customer_field.rb
@@ -38,1 +38,1 @@
-  puts "ERROR: Cannot connect to Redis: #{ex.message}"
+  puts "ERROR: Cannot connect to the database: #{ex.message}"
@@ -49,1 +49,1 @@
-    # How the record is identified/stored in Redis
+    # How the record is identified/stored in the database
@@ -104,1 +104,1 @@
-  # Extract just the IDs from problem_customers array and save to Redis.
+  # Extract just the IDs from problem_customers array and save to the database.
@@ -116,1 +116,1 @@
-    puts "Saved #{problem_customers.size} customer IDs to Redis list '#{list_key}'"
+    puts "Saved #{problem_customers.size} customer IDs to the database list '#{list_key}'"

--- a/spec/onetime/config/after_load_spec.rb
+++ b/spec/onetime/config/after_load_spec.rb
@@ -122,1 +122,1 @@
-      it 'sets Familia URI from Redis config when we want DB connection' do
+      it 'sets Familia URI from the database config when we want DB connection' do
@@ -175,1 +175,1 @@
-        expect(Onetime).to receive(:le).with(/Cannot connect to redis .* \(Redis::CannotConnectError\)/)
+        expect(Onetime).to receive(:le).with(/Cannot connect to the database .* \(Redis::CannotConnectError\)/)

--- a/spec/onetime/initializers/boot_part1_spec.rb
+++ b/spec/onetime/initializers/boot_part1_spec.rb
@@ -241,1 +241,1 @@
-      ENV['REDIS_URL'] = 'redis://127.0.0.1:2121/0'
+      ENV['VALKEY_URL'] = 'redis://127.0.0.1:2121/0'
@@ -255,1 +255,1 @@
-      #    REDIS_URL=redis://127.0.0.1:2121/0 pnpm test:rspec
+      #    VALKEY_URL=redis://127.0.0.1:2121/0 pnpm test:rspec
@@ -285,1 +285,1 @@
-      it "sets Onetime.global_banner to the banner from Redis if present" do
+      it "sets Onetime.global_banner to the banner from the database if present" do
@@ -287,1 +287,1 @@
-        # Familia.redis is redis_double from the outer before_each block
+        # Familia.dbclient is redis_double from the outer before_each block
@@ -288,1 +288,1 @@
-        allow(Familia.redis).to receive(:get).with('global_banner').and_return(test_banner_text)
+        allow(Familia.dbclient).to receive(:get).with('global_banner').and_return(test_banner_text)
@@ -296,1 +296,1 @@
-        allow(Familia.redis).to receive(:get).with('global_banner').and_return(nil) # Explicitly ensure nil
+        allow(Familia.dbclient).to receive(:get).with('global_banner').and_return(nil) # Explicitly ensure nil
@@ -416,1 +416,1 @@
-        # Familia.redis.serverid is stubbed in the main before(:each)
+        # Familia.dbclient.serverid is stubbed in the main before(:each)

--- a/spec/onetime/initializers/boot_part2_spec.rb
+++ b/spec/onetime/initializers/boot_part2_spec.rb
@@ -153,1 +153,1 @@
-      it "sets Onetime.global_banner from Redis if present" do
+      it "sets Onetime.global_banner from the database if present" do
@@ -219,1 +219,1 @@
-        # before any actual network connection to a Redis server is attempted by Familia.
+        # before any actual network connection to a database server is attempted by Familia.

--- a/spec/unit/onetime/services/system/first_boot_spec.rb
+++ b/spec/unit/onetime/services/system/first_boot_spec.rb
@@ -145,1 +145,1 @@
-          expect(OT).to receive(:lw).with('[BOOT.first_boot] Cannot connect to Redis for mutable config setup: Connection refused')
+          expect(OT).to receive(:lw).with('[BOOT.first_boot] Cannot connect to the database for mutable config setup: Connection refused')

--- a/etc/config.yaml
+++ b/etc/config.yaml
@@ -170,1 +170,1 @@
-  uri: <%= ENV['REDIS_URL'] || 'redis://localhost:6379' %>
+  uri: <%= ENV['VALKEY_URL'] || 'redis://localhost:6379' %>

--- a/etc/defaults/config.defaults.yaml
+++ b/etc/defaults/config.defaults.yaml
@@ -160,1 +160,1 @@
-  uri: <%= ENV['REDIS_URL'] || 'redis://CHANGEME@127.0.0.1:6379/0' %>
+  uri: <%= ENV['VALKEY_URL'] || 'redis://CHANGEME@127.0.0.1:6379/0' %>

--- a/docs/.claude/previous/tests-migration/config.test.yaml
+++ b/docs/.claude/previous/tests-migration/config.test.yaml
@@ -22,1 +22,1 @@
-      url: <%= ENV['REDIS_URL'] || 'redis://CHANGEME@127.0.0.1:2121/0' %>
+      url: <%= ENV['VALKEY_URL'] || 'redis://CHANGEME@127.0.0.1:2121/0' %>

--- a/docs/.claude/previous/tests-migration/spec_helper.rb
+++ b/docs/.claude/previous/tests-migration/spec_helper.rb
@@ -148,1 +148,1 @@
-      # This is a safety net - it will raise an error if any code tries to actually connect to Redis
+      # This is a safety net - it will raise an error if any code tries to actually connect to the database

--- a/docs/0725-familia-connection-pooling-implementation-plan-feedback-opus.md
+++ b/docs/0725-familia-connection-pooling-implementation-plan-feedback-opus.md
@@ -300,1 +300,1 @@
-    Secret.redis.ping
+    Secret.dbclient.ping
@@ -301,1 +301,1 @@
-    assert_equal 8, Secret.redis.connection[:db]
+    assert_equal 8, Secret.dbclient.connection[:db]
@@ -303,1 +303,1 @@
-    Session.redis.ping
+    Session.dbclient.ping
@@ -304,1 +304,1 @@
-    assert_equal 1, Session.redis.connection[:db]
+    assert_equal 1, Session.dbclient.connection[:db]
@@ -306,1 +306,1 @@
-    RateLimit.redis.ping
+    RateLimit.dbclient.ping
@@ -307,1 +307,1 @@
-    assert_equal 2, RateLimit.redis.connection[:db]
+    assert_equal 2, RateLimit.dbclient.connection[:db]

--- a/docs/0725-familia-connection-pooling-implementation-plan.md
+++ b/docs/0725-familia-connection-pooling-implementation-plan.md
@@ -124,1 +124,1 @@
-    redis = Familia.redis(db_index)
+    redis = Familia.dbclient(db_index)
@@ -180,1 +180,1 @@
-    redis = Familia.redis(db_index)
+    redis = Familia.dbclient(db_index)

--- a/docs/0803-encryption-update.md
+++ b/docs/0803-encryption-update.md
@@ -239,1 +239,1 @@
-    @redis = Onetime.redis
+    @redis = Onetime.dbclient
@@ -290,1 +290,1 @@
-      # Extract secret ID from redis key
+      # Extract secret ID from database key

--- a/docs/DOCKER.md
+++ b/docs/DOCKER.md
@@ -54,1 +54,1 @@
-        -e REDIS_URL=redis://host.docker.internal:6379/0 \
+        -e VALKEY_URL=redis://host.docker.internal:6379/0 \
@@ -73,1 +73,1 @@
-2.  **Edit your `.env` file.** Open `.env` and set a unique `SECRET`. You can generate one with `openssl rand -hex 24`. Also, ensure `REDIS_URL` points to your Valkey/Redis instance.
+2.  **Edit your `.env` file.** Open `.env` and set a unique `SECRET`. You can generate one with `openssl rand -hex 24`. Also, ensure `VALKEY_URL` points to your Valkey/Redis instance.
@@ -110,1 +110,1 @@
-    > When you mount a custom config file, you are responsible for maintaining it. Ensure it includes all necessary settings for your deployment, including a strong `SECRET` and correct `REDIS_URL`.
+    > When you mount a custom config file, you are responsible for maintaining it. Ensure it includes all necessary settings for your deployment, including a strong `SECRET` and correct `VALKEY_URL`.
@@ -117,1 +117,1 @@
-- `REDIS_URL`: URL for your Valkey/Redis instance.
+- `VALKEY_URL`: URL for your Valkey/Redis instance.
@@ -125,1 +125,1 @@
-- Valkey/Redis server 5+ (or compatible)
+- Valkey/database server 5+ (or compatible)

--- a/docs/_archive_config/config-596-markdown.yaml
+++ b/docs/_archive_config/config-596-markdown.yaml
@@ -200,1 +200,1 @@
-  :uri: <%= ENV['REDIS_URL'] || 'redis://localhost:6379' %>
+  :uri: <%= ENV['VALKEY_URL'] || 'redis://localhost:6379' %>

--- a/docs/_archive_config/config-BU-june2.yaml
+++ b/docs/_archive_config/config-BU-june2.yaml
@@ -198,1 +198,1 @@
-  :uri: <%= ENV['REDIS_URL'] || 'redis://localhost:6379' %>
+  :uri: <%= ENV['VALKEY_URL'] || 'redis://localhost:6379' %>

--- a/docs/_archive_config/config.example-BU-june2.yaml
+++ b/docs/_archive_config/config.example-BU-june2.yaml
@@ -169,1 +169,1 @@
-  :uri: <%= ENV['REDIS_URL'] || 'redis://CHANGEME@127.0.0.1:6379/0' %>
+  :uri: <%= ENV['VALKEY_URL'] || 'redis://CHANGEME@127.0.0.1:6379/0' %>

--- a/docs/_archive_config/config.wip.static.yaml
+++ b/docs/_archive_config/config.wip.static.yaml
@@ -50,1 +50,1 @@
-  :uri: <%= ENV['REDIS_URL'] || 'redis://CHANGEME@127.0.0.1:6379/0' %>
+  :uri: <%= ENV['VALKEY_URL'] || 'redis://CHANGEME@127.0.0.1:6379/0' %>

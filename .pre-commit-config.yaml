##
# Pre-Commit Hooks Configuration
#
# Fast, lightweight code quality checks that run before each commit
#
# Setup:
#   1. Install pre-commit:
#       $ pip install pre-commit
#
#   2. Install git hooks:
#       $ pre-commit install
#
# Usage:
#   Hooks run automatically on 'git commit'
#
#   Manual commands:
#   - Check all files:
#     $ pre-commit run --all-files
#
#   - Update hooks:
#     $ pre-commit autoupdate
#
#   - Reinstall after config changes:
#     $ pre-commit install
#
# Best Practices:
#   - Reinstall hooks after modifying this config
#   - Commit config changes in isolation
#   - Keep checks fast to maintain workflow
#
# Resources:
#   - Docs: https://pre-commit.com
#   - Available hooks: https://pre-commit.com/hooks.html
#
# Note: These lightweight checks maintain code quality without
# slowing down the local development process.

# Hook installation configuration
default_install_hook_types:
  - pre-commit
  - prepare-commit-msg
  - post-commit
  - post-checkout
  - post-merge

# Default execution stage
default_stages: [pre-commit]

# Use 'system' to leverage existing rbenv/nvm installations from PATH,
# while pre-commit still manages isolated gem/package environments.
default_language_version:
  ruby: system
  node: system

# Allow all hooks to run even if one (or more fails). This avoids
# the commit->fail->fix->commit->fail->fix->commit routine.
fail_fast: false

# Ignore generated and dependency directories
exclude: '^$'

repos:
  # Meta hooks: basic checks for pre-commit config itself
  - repo: meta
    hooks:
      - id: check-hooks-apply
      - id: check-useless-excludes
      - id: identity
        name: Identity Hook (for sanity checking)
        args: ['--hello', '--world']

  # Standard pre-commit hooks: lightweight, universal checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-merge-conflict
      - id: detect-private-key
      - id: check-added-large-files
        args: ['--maxkb=2500']
      - id: no-commit-to-branch
        args: ['--branch', 'develop', '--branch', 'rel/.*']

  # Commit message issue tracking integration
  - repo: https://github.com/delano/add-msg-issue-prefix-hook
    rev: v0.0.14-fork
    hooks:
      - id: add-msg-issue-prefix
        stages: [prepare-commit-msg]
        description: Automatically prefix commits with issue numbers
        args:
          - '--default='
          - '--exclude-pattern=^(dependabot|renovate)/'
          - '--pattern=(i18n(?=/)|([a-zA-Z0-9]{0,10}-?[0-9]{1,5}))'
          - '--template=[#{}]'

  # Ruby Linting: Managed RuboCop environment
  - repo: https://github.com/rubocop/rubocop
    rev: v1.81.7
    hooks:
      - id: rubocop
        name: RuboCop
        description: Ruby static code analyzer and formatter
        additional_dependencies:
          - rubocop-performance:1.26.1
          - rubocop-rspec:3.8.0
          - rubocop-sequel:0.4.1
          - rubocop-thread_safety:0.7.3

  # Ensure ESLint can run by creating stub if auto-import config is missing
  # (Generated by unplugin-auto-import during pnpm dev/build, but gitignored)
  - repo: local
    hooks:
      - id: ensure-eslint-auto-imports
        stages: [pre-commit]
        name: Ensure ESLint auto-imports config
        entry: bash -c '[ -f src/.eslintrc-auto-import.json ] || echo "{\"globals\":{}}" > src/.eslintrc-auto-import.json'
        language: system
        pass_filenames: false
        always_run: true

  # JavaScript/TypeScript Linting: Use project's ESLint installation
  # Note: Uses language: system to leverage the project's node_modules,
  # ensuring eslint.config.ts has access to all required plugins and configs.
  # The isolated `language: node` approach fails because flat config requires
  # the full project context (path aliases, vue-eslint-parser setup, etc.).
  - repo: local
    hooks:
      - id: eslint
        name: ESLint
        description: High-performance linting for TypeScript and Vue
        entry: ./node_modules/.bin/eslint --quiet --config eslint.config.ts --fix
        language: system
        files: \.(ts|vue|mjs)$

  # Commit metadata tracking
  - repo: local
    hooks:
      - id: register-build
        stages: [post-commit, post-checkout, post-merge]
        name: Record commit hash
        description: Log current commit hash for build reference
        entry: "sh -c 'git rev-parse --short HEAD > .commit_hash.txt; echo Commit hash recorded; head -4 .commit_hash.txt package.json'"
        language: system
        always_run: true
        pass_filenames: false

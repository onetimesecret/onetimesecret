Okay, here's a concise reference for future bug fixing related to `Onetime.boot!` and `Onetime::Config.after_load`:

### Key Bug Areas & Fix Strategies:

1.  **`Onetime::Config.after_load` Side Effects:**
    *   **Issue:** `after_load` inconsistently modifies the global `OT.conf` directly instead of solely operating on its `conf` argument. This affects how settings like authentication sub-features, TTLs, and the diagnostics `enabled` flag are finalized.
    *   **Symptom:** The `conf` object passed to `after_load` might not reflect the true final configuration state because `OT.conf` is being altered "underneath."
    *   **Fix Strategy:** Refactor `Onetime::Config.after_load` to:
        1.  Operate *exclusively* on the `conf` hash it receives as an argument.
        2.  Return the modified `conf` hash.
        3.  In `Onetime.boot!`, update `OT.conf` with the returned hash: `OT.conf = OT::Config.after_load(OT.conf)`.

2.  **Stale `OT.conf[:diagnostics][:enabled]` State:**
    *   **Issue:** During `Onetime.boot!`, `OT.d9s_enabled` is initialized (e.g., to `false`). `Onetime::Config.after_load` then uses this initial `OT.d9s_enabled` value to help determine `OT.conf[:diagnostics][:enabled]`. *After* this, `OT.d9s_enabled` is properly updated based on DSN presence and the config.
    *   **Symptom:** `OT.conf[:diagnostics][:enabled]` reflects the `OT.d9s_enabled` state *before* DSN processing, while `OT.d9s_enabled` itself holds the correct final status of whether diagnostics are *actually* active.
    *   **Fix Strategy:**
        *   Ensure `OT.conf[:diagnostics][:enabled]` is set *after* `OT.d9s_enabled` is definitively determined within `after_load`.
        *   Alternatively, consistently rely on `Onetime.d9s_enabled` as the single source of truth for active diagnostics status, and consider removing `OT.conf[:diagnostics][:enabled]` if redundant.

### Important Considerations:

*   **ERB in Configuration (`config.test.yaml`):**
    *   ERB templates (e.g., `<%= ENV['VAR'] || 'default' %>`) are evaluated *once* when the configuration file is loaded.
    *   Changes to environment variables *after* `Onetime::Config.load` (or `Onetime.boot!`) will not re-trigger ERB evaluation for that loaded instance.
    *   For tests needing dynamic config values based on `ENV`, set environment variables *before* the config is loaded, or directly mock `OT.conf` values.

*   **Order of Operations in `Onetime.boot!`:**
    *   The sequence is:
        1.  `OT.conf = OT::Config.load(...)`
        2.  `OT::Config.after_load(OT.conf)` (critical mutation point for `OT.conf` and finalization of `OT.d9s_enabled`)
        3.  Subsequent initializations (`set_global_secret`, `prepare_emailers`, `connect_databases`, etc.) rely on the state of `OT.conf` *after* `after_load`.
    *   Fixing the `after_load` side effects (Bug 1 & 2) is crucial as these directly impact all subsequent setup steps.

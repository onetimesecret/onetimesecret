# docs/test-plans/edge-cases.yaml
---
# LLM-Optimized Test Cases: Billing & Auth Edge Cases
# Version: 1.1.0

suite:
  id: billing-auth-edge-cases
  name: Billing & Auth Edge Cases
  feature: Edge cases for billing disabled mode, free tier limits, session expiry, and entitlement enforcement
  tags: [billing, auth, edge-cases, entitlements, standalone]
  notes: |
    These tests cover boundary conditions and failure modes in billing/auth flows.
    Some tests require specific deployment configurations (standalone vs hosted).

# -----------------------------------------------------------------------------
# SHARED DEFINITIONS
# -----------------------------------------------------------------------------

definitions:
  users:
    free_user:
      description: Authenticated user on Free plan
      auth: logged_in
    paid_user:
      description: User with active paid subscription
      auth: logged_in
      state:
        plan: identity_plus

  fixtures:
    default_workspace:
      type: organization
      props:
        name: Workspace
        is_default: true

# -----------------------------------------------------------------------------
# TEST CASES
# -----------------------------------------------------------------------------

tests:
  # ---------------------------------------------------------------------------
  # CRITICAL: Billing Disabled Mode (Standalone Deployment)
  # ---------------------------------------------------------------------------

  - id: EDGE-001
    intent: Standalone deployment hides all billing UI elements
    setup:
      auth: logged_in
      user_type: free_user
      description: Billing disabled in deployment configuration
      state:
        billing_enabled: false
    target: /dashboard
    verify:
      - description: Bootstrap confirms billing is disabled
        api: GET /bootstrap/me
        assert:
          billing_enabled: false
      - description: No Upgrade button visible in header or dashboard
        selector: "[data-testid='upgrade-banner'], [data-testid='upgrade-button'], [aria-label='Upgrade offer']"
        assertion: not_visible
      - description: No Plans or Billing links in navigation
        selector: "nav a[href*='/billing'], nav a[href*='/plans']"
        assertion: not_visible
      - description: User menu dropdown has no billing option
        action:
          click: "[data-testid='user-menu-trigger']"
        selector: "[data-testid='user-menu-dropdown'] a[href*='/billing']"
        assertion: not_visible
      - description: Footer contains no pricing or plans links
        selector: "footer a[href*='/billing/plans'], footer a[href*='/pricing']"
        assertion: not_visible
    priority: critical
    type: edge
    covers: [bootstrapStore.billing_enabled, navigation guards]
    skip:
      reason: Only applicable to standalone deployments
      when: hosted_mode
    notes: |
      In standalone mode, billing_enabled=false in bootstrap data.
      All billing routes should be hidden, not just disabled.

  - id: EDGE-002
    intent: Standalone mode grants full entitlements without subscription
    setup:
      auth: logged_in
      user_type: free_user
      state:
        billing_enabled: false
    target: /org
    verify:
      - description: Bootstrap confirms standalone mode entitlements
        api: GET /bootstrap/me
        assert:
          billing_enabled: false
      - description: Organization settings show no plan restrictions
        selector: "[data-testid='plan-restriction-notice'], [data-testid='upgrade-required-message']"
        assertion: not_visible
      - description: Custom domains feature accessible without upgrade prompt
        action:
          navigate: /domains
        selector: "[data-testid='add-domain-button']"
        assertion: enabled
        absence_check:
          selector: "[role='alert'][data-testid='upgrade-prompt']"
          assertion: not_visible
      - description: Teams feature accessible without upgrade prompt
        action:
          navigate: /org/teams
        selector: "[data-testid='add-team-button'], [data-testid='team-list']"
        assertion: visible
        absence_check:
          selector: "[role='alert'][data-testid='upgrade-prompt']"
          assertion: not_visible
      - description: No upgrade required messaging anywhere on organization pages
        selector: "[data-testid='upgrade-required'], [data-testid='upgrade-prompt'], [role='alert']:has-text('upgrade')"
        assertion: not_visible
    priority: critical
    type: edge
    covers: [WithEntitlements.can?, standalone entitlements]
    skip:
      reason: Only applicable to standalone deployments
      when: hosted_mode
    notes: |
      org.can?() returns true for all features when billing is disabled.
      STANDALONE_ENTITLEMENTS includes: api_access, custom_domains,
      custom_branding, manage_teams, manage_orgs, audit_logs, etc.

  # ---------------------------------------------------------------------------
  # HIGH: Free Tier Limits
  # ---------------------------------------------------------------------------

  - id: EDGE-003
    intent: Free user encounters upgrade prompt when attempting premium feature
    setup:
      auth: logged_in
      user_type: free_user
      state:
        plan: free_v1
        billing_enabled: true
    target: /org/domains
    action:
      type: click
      element: "[data-testid='add-domain-button']"
    verify:
      - description: Upgrade prompt modal or inline message appears
        selector: "[role='alert'][data-testid='upgrade-prompt'], [data-testid='entitlement-upgrade-prompt']"
        assertion: visible
        timeout: 3000
      - description: Message explains feature requires paid plan
        selector: "[data-testid='upgrade-prompt-message'], [data-testid='entitlement-upgrade-prompt']"
        assertion:
          text_matches: "(upgrade|paid plan|subscription required)"
      - description: Clear path to upgrade with link to billing plans
        selector: "a[href*='/billing/plans'], a[href*='/billing'][data-testid='view-plans-link']"
        assertion: visible
      - description: No silent failure or generic error
        selector: "[role='alert']:not([data-testid='upgrade-prompt'])"
        assertion: not_visible
    priority: high
    severity: major
    type: edge
    covers: [custom_domains entitlement, upgrade prompts]
    notes: |
      Free tier has can?('custom_domains') = false.
      UI should gracefully prompt upgrade, not error.

  - id: EDGE-004
    intent: Free user sees correct TTL limit for secret lifetime
    setup:
      auth: logged_in
      user_type: free_user
      state:
        plan: free_v1
    target: /
    verify:
      - description: Bootstrap returns free tier TTL limits
        api: GET /bootstrap/me
        assert:
          secret_options.ttl.max:
            operator: lte
            value: 604800
      - description: Secret creation form shows TTL options
        selector: "[data-testid='ttl-select'], select[name='ttl'], [data-testid='lifetime-select']"
        assertion: visible
      - description: Maximum TTL option reflects free tier limit (7 days / 604800 seconds)
        selector: "[data-testid='ttl-select'] option:last-child, [data-testid='lifetime-select'] option:last-child"
        assertion:
          attribute_lte:
            name: value
            value: 604800
      - description: No options beyond free tier limit available
        selector: "[data-testid='ttl-select'] option[value='1209600'], [data-testid='lifetime-select'] option[value='2592000']"
        assertion: not_exists
      - description: Tooltip or help text explains limits if present
        selector: "[data-testid='ttl-help-text'], [data-testid='lifetime-tooltip']"
        assertion: optional
    priority: high
    type: edge
    covers: [limit_for('secret_lifetime'), TTL controls]
    notes: |
      FREE_TIER_LIMITS['secret_lifetime.max'] = 604800 (7 days).
      BaseSecretAction uses org.limit_for('secret_lifetime') for max TTL.

  # ---------------------------------------------------------------------------
  # HIGH: Session Expiry During Checkout
  # ---------------------------------------------------------------------------

  - id: EDGE-005
    intent: Expired session during checkout redirects to login with return URL
    setup:
      auth: logged_in
      user_type: free_user
      description: Session will expire during checkout flow
    target: /billing/plans
    precondition:
      description: Simulate session expiry by clearing session cookie
      action:
        clear_cookie: session
    action:
      type: click
      element: "[data-testid='select-plan-button']"
    verify:
      - description: Redirect to login page occurs after session expiry
        url:
          path_matches: "^/signin|^/login"
        timeout: 5000
      - description: Login page shows session expired message
        selector: "[role='alert'][data-testid='session-expired-message'], [data-testid='auth-message']"
        assertion:
          any_of:
            - visible
            - text_matches: "(session expired|please sign in again|logged out)"
      - description: Return URL is preserved in query parameters
        url:
          query_contains: "redirect|return_to|next"
      - description: After re-login user returns to billing flow
        action:
          submit_login:
            email: testuser@example.com
            password: validPassword123
        url:
          path_contains: /billing
        timeout: 5000
    priority: high
    severity: major
    type: edge
    covers: [session middleware, checkout flow, return URLs]
    notes: |
      Simulating this requires either waiting for session timeout
      or manually clearing session cookie mid-flow.
      Agent should document observed behavior.

  # ---------------------------------------------------------------------------
  # MEDIUM: Entitlement Enforcement
  # ---------------------------------------------------------------------------

  - id: EDGE-006
    intent: API enforces entitlements even if UI is bypassed
    setup:
      auth: logged_in
      user_type: free_user
      state:
        plan: free_v1
    target: /api/v2/domains
    action:
      type: api_request
      method: POST
      body:
        domain: test.example.com
    verify:
      - description: API returns 403 Forbidden status for entitlement violation
        api: POST /api/v2/domains
        body:
          domain: test.example.com
        assert:
          status: 403
      - description: Error response indicates feature not available on plan
        api_response:
          assert:
            any_of:
              - body.error:
                  matches: "(entitlement|feature|not available|upgrade|subscription)"
              - body.message:
                  matches: "(entitlement|feature|not available|upgrade|subscription)"
              - body.details.code:
                  equals: "ENTITLEMENT_DENIED"
      - description: No domain created in system
        api: GET /api/v2/domains
        assert:
          body.records:
            not_contains:
              domain: test.example.com
    priority: medium
    severity: major
    type: edge
    covers: [AddDomain.can?, API entitlement guards]
    notes: |
      Backend checks target_organization.can?('custom_domains') in AddDomain.
      This test verifies defense in depth beyond UI hiding.

# docs/test-plans/login-auth.yaml
---
# LLM-Optimized Test Cases: Login and Authentication
# Schema version: 1.0.0

suite:
  id: login-auth
  name: Login and Authentication Flow
  feature: User authentication via SignInForm component
  tags: [auth, login, mfa, session, security]

definitions:
  users:
    anonymous:
      auth: logged_out
      description: Unauthenticated user on login page
    valid_credentials:
      auth: logged_out
      description: User with valid test credentials
    mfa_enabled:
      auth: logged_out
      description: User with MFA enabled on account

tests:
  - id: TC-LA-001
    intent: Valid credentials successfully authenticate user and redirect to home page
    setup:
      auth: logged_out
      state:
        test_email: testuser@example.com
        test_password: validPassword123
    target: /signin
    action:
      type: submit
      element: Sign in form
      data:
        email: testuser@example.com
        password: validPassword123
    verify:
      - User is redirected to home page after successful login
      - No error message is displayed
      - User menu or authenticated UI elements are visible
      - selector: "#signin-error"
        assertion: hidden
    priority: critical
    severity: blocker
    type: functional
    covers: [SignInForm, useAuth.login, authStore]

  - id: TC-LA-002
    intent: Invalid password shows generic error without revealing email existence
    setup:
      auth: logged_out
    target: /signin
    action:
      type: submit
      element: Sign in form
      data:
        email: testuser@example.com
        password: wrongPassword123
    verify:
      - Error message is displayed in alert container
      - Error message is generic (does not reveal if email exists)
      - Form remains on login page (no redirect)
      - Password field is available for re-entry
      - selector: "[role='alert']"
        assertion: visible
    priority: critical
    severity: blocker
    type: error
    covers: [SignInForm, useAuth.login, security]
    notes: Error message must not distinguish between email not found and wrong password

  - id: TC-LA-003
    intent: User with MFA enabled is redirected to MFA verification after valid credentials
    setup:
      auth: logged_out
      state:
        mfa_enabled: true
    target: /signin
    action:
      type: submit
      element: Sign in form
      data:
        email: mfa-user@example.com
        password: validPassword123
    verify:
      - User is redirected to /mfa-verify
      - MFA verification form is displayed
      - No error message shown (credentials were valid)
      - User is not fully authenticated yet
    postconditions:
      - bootstrapStore.awaiting_mfa is true
      - bootstrapStore.authenticated is false
    priority: critical
    severity: blocker
    type: functional
    covers: [SignInForm, useAuth.login, MFA flow, bootstrapStore]
    notes: Login succeeds but returns mfa_required flag triggering redirect to /mfa-verify

  - id: TC-LA-004
    intent: User with pending plan selection is redirected to billing after login
    setup:
      auth: logged_out
      state:
        pending_plan_selection: true
    target: /signin?plan=identity&interval=month
    action:
      type: submit
      element: Sign in form
      data:
        email: newuser@example.com
        password: validPassword123
    verify:
      - User is redirected to billing plans page after successful login
      - URL contains billing path with plan parameters preserved
      - Plan selection UI is displayed
    priority: high
    severity: major
    type: functional
    covers: [SignInForm, useAuth.login, handleBillingRedirect, extractBillingParams]
    notes: Billing params from query string are passed through login and trigger post-auth redirect

  - id: TC-LA-005
    intent: Remember me checkbox extends session duration across browser restarts
    setup:
      auth: logged_out
    target: /signin
    action:
      type: submit
      element: Sign in form
      data:
        email: testuser@example.com
        password: validPassword123
        remember_me: true
    verify:
      - User is authenticated after login
      - Remember me checkbox was checked before submit
      - Session cookie has extended expiration (not session-only)
      - User remains logged in on page reload
    priority: high
    severity: major
    type: functional
    covers: [SignInForm, useAuth.login, session persistence]
    notes: Full test requires simulating browser restart; partial test verifies checkbox state and cookie type

  - id: TC-LA-006
    intent: Unverified account receives appropriate feedback during login attempt
    setup:
      auth: logged_out
      state:
        account_verified: false
    target: /signin
    action:
      type: submit
      element: Sign in form
      data:
        email: unverified@example.com
        password: validPassword123
    verify:
      - Appropriate message about email verification is displayed
      - User is either blocked from login or shown verification prompt
      - Path to request new verification email is available or indicated
    priority: high
    severity: major
    type: error
    covers: [SignInForm, useAuth.login, account verification]
    notes: Behavior depends on site configuration - may allow login with warning or block until verified

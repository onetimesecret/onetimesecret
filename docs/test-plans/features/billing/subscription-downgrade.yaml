# docs/test-plans/subscription-downgrade.yaml
---
# LLM-Optimized Test Cases: Subscription Downgrade
# Version: 1.1.0

suite:
  id: subscription-downgrade
  name: Subscription Downgrade - Credit Preview and Plan Changes
  feature: Downgrade flow with proration credit handling
  tags: [billing, downgrade, proration, subscription, stripe]
  notes: |
    Plan hierarchy (descending value):
    Team Plus ($85/mo) -> Identity Plus ($35/mo) -> Free ($0)
    Downgrades generate proration credits for unused subscription time.

definitions:
  users:
    team_plus_user:
      auth: logged_in
      description: User with active Team Plus subscription
    identity_plus_user:
      auth: logged_in
      description: User with active Identity Plus subscription

tests:
  - id: DOWNGRADE-001
    intent: User sees proration credit preview before confirming downgrade from Team Plus to Identity Plus
    setup:
      auth: logged_in
      user_type: team_plus_user
      description: User on Team Plus plan with mid-cycle billing period
      state:
        current_plan: team_plus_v1
        subscription_status: active
    target: /billing/:extid/plans
    action:
      type: click
      element: Select button on Identity Plus plan card
      selector: "[data-testid='plan-card-identity_plus_v1'] [data-testid='select-plan-button']"
    verify:
      - description: PlanChangeModal opens with yellow downgrade styling
        selector: "[data-testid='plan-change-modal']"
        assert: visible
        has_class: border-yellow-500
      - description: Modal title shows Downgrade to Identity Plus
        selector: "[data-testid='plan-change-modal-title']"
        assert: text_contains
        value: Downgrade to Identity Plus
      - description: Current plan displays Team Plus with price
        selector: "[data-testid='current-plan-display']"
        assert: text_contains
        value: Team Plus
      - description: New plan displays Identity Plus with price
        selector: "[data-testid='new-plan-display']"
        assert: text_contains
        value: Identity Plus
      - description: Credit for unused time shows positive amount
        selector: "[data-testid='credit-amount']"
        assert: text_matches
        pattern: "\\$\\d+\\.\\d{2}"
      - description: Network request to preview-plan-change returns 200
        api: POST /billing/api/org/:extid/preview-plan-change
        assert: status
        value: 200
      - description: Preview response contains credit_applied greater than 0
        api: POST /billing/api/org/:extid/preview-plan-change
        assert: json_path
        path: $.credit_applied
        condition: greater_than
        value: 0
    priority: critical
    type: functional
    covers:
      - PlanChangeModal.vue
      - POST /billing/api/org/:extid/preview-plan-change
      - BillingService.previewPlanChange

  - id: DOWNGRADE-002
    intent: User confirms downgrade from Team Plus to Identity Plus and subscription updates immediately
    setup:
      auth: logged_in
      user_type: team_plus_user
      description: Team Plus user with preview modal open for Identity Plus
      state:
        current_plan: team_plus_v1
        subscription_status: active
        modal_open: true
        target_plan: identity_plus_v1
    target: /billing/:extid/plans
    action:
      type: click
      element: Confirm Downgrade button in modal
      selector: "[data-testid='confirm-plan-change-button']"
    verify:
      - description: Network request to change-plan returns success
        api: POST /billing/api/org/:extid/change-plan
        assert: status
        value: 200
      - description: Modal closes after successful change
        selector: "[data-testid='plan-change-modal']"
        assert: not_visible
      - description: Success message displays new plan name
        selector: "[data-testid='plan-change-success-message']"
        assert: text_contains
        value: Identity Plus
      - description: Plan selector refreshes to show Identity Plus as current plan
        selector: "[data-testid='current-plan-badge']"
        assert: text_contains
        value: Identity Plus
        api_fallback:
          api: GET /bootstrap/me
          assert: json_path
          path: $.organization.plan.code
          value: identity_plus_v1
      - description: No console errors during plan change
        assert: console_errors
        value: 0
    priority: critical
    type: functional
    covers:
      - PlanChangeModal.vue handleConfirm
      - POST /billing/api/org/:extid/change-plan
      - BillingService.changePlan
    postconditions:
      - Subscription updated in Stripe
      - Feature limits updated immediately

  - id: DOWNGRADE-003
    intent: Downgrade with significant credit shows credit breakdown and remaining balance
    setup:
      auth: logged_in
      user_type: team_plus_user
      description: User on Team Plus near start of billing cycle (high credit available)
      state:
        current_plan: team_plus_v1
        subscription_status: active
        billing_cycle_position: early
    target: /billing/:extid/plans
    action:
      type: click
      element: Select button on Identity Plus plan card
      selector: "[data-testid='plan-card-identity_plus_v1'] [data-testid='select-plan-button']"
    verify:
      - description: Credit breakdown section visible when credit exceeds next bill
        precondition:
          api: POST /billing/api/org/:extid/preview-plan-change
          assert: json_path
          path: $.credit_applied
          condition: greater_than_or_equal
          compare_path: $.next_period_amount
        selector: "[data-testid='credit-breakdown-section']"
        assert: visible
      - description: How your credit applies heading displays
        selector: "[data-testid='credit-breakdown-heading']"
        assert: text_contains
        value: How your credit applies
      - description: Next bill amount shows Identity Plus price
        selector: "[data-testid='next-bill-amount']"
        assert: text_contains
        value: "$35.00"
      - description: Credit applied line shows negative amount (green)
        selector: "[data-testid='credit-applied-line']"
        assert: text_matches
        pattern: "-\\$\\d+\\.\\d{2}"
        has_class: text-green
      - description: Amount due at next billing shows $0 or reduced amount
        selector: "[data-testid='amount-due']"
        assert: text_matches
        pattern: "\\$\\d+\\.\\d{2}"
        condition: less_than_or_equal
        compare_value: 35.00
      - description: Remaining account credit displays if credit exceeds next bill
        precondition:
          api: POST /billing/api/org/:extid/preview-plan-change
          assert: json_path
          path: $.credit_applied
          condition: greater_than
          compare_path: $.next_period_amount
        selector: "[data-testid='remaining-credit-display']"
        assert: visible
      - description: Note about credit applying to future invoices visible
        selector: "[data-testid='credit-future-invoices-note']"
        assert: visible
    priority: high
    type: functional
    covers:
      - PlanChangeModal.vue showCreditBreakdown computed
      - PlanChangeModal.vue remainingCreditAfterBill computed
      - PlanChangeModal.vue creditAppliedToBill computed
    notes: |
      Credit breakdown appears when credit_applied >= next_period_amount.
      Remaining credit carries forward to future invoices.

  - id: DOWNGRADE-004
    intent: Paid user downgrades to Free plan via subscription cancellation flow
    setup:
      auth: logged_in
      user_type: identity_plus_user
      description: User on Identity Plus wants to return to Free tier
      state:
        current_plan: identity_plus_v1
        subscription_status: active
    target: /billing/:extid/plans
    action:
      type: click
      element: Cancel subscription link
      selector: "[data-testid='cancel-subscription-link']"
    verify:
      - description: CancelSubscriptionModal opens with confirmation prompt
        selector: "[data-testid='cancel-subscription-modal']"
        assert: visible
      - description: Warning explains access retained until billing period ends
        selector: "[data-testid='cancel-warning-message']"
        assert: text_contains
        value: until billing period ends
      - description: Your account will revert to the free plan message visible
        selector: "[data-testid='cancel-revert-message']"
        assert: text_contains
        value: revert to the free plan
      - description: After confirmation, subscription status shows cancel_at_period_end
        action:
          type: click
          selector: "[data-testid='confirm-cancel-button']"
        api: GET /bootstrap/me
        assert: json_path
        path: $.organization.subscription.status
        value: cancel_at_period_end
      - description: Cancel subscription button disabled during processing
        selector: "[data-testid='confirm-cancel-button']"
        assert: disabled
        during: api_request
    priority: high
    type: functional
    covers:
      - CancelSubscriptionModal.vue
      - POST /billing/api/org/:extid/cancel-subscription
      - BillingService.cancelSubscription
    notes: |
      Free tier downgrade uses cancellation flow rather than plan change.
      Access continues until current billing period expires.

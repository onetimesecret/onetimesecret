# docs/test-plans/issue-2114-secret-context.yaml
---
# LLM-Optimized Test Cases: Secret Context Actor Roles
# Converted from: issue-2114-interaction-modes.md
# Schema version: 1.0.0

suite:
  id: secret-context-actor-roles
  name: Secret Context - Actor Roles
  feature: useSecretContext() composable
  issue: https://github.com/onetimesecret/onetimesecret/issues/2114
  tags: [vue, composable, auth, secret-reveal]

definitions:
  users:
    creator: &user_creator
      auth: logged_in
      user_type: creator
      description: User who created the secret being tested

    recipient_auth: &user_recipient_auth
      auth: logged_in
      user_type: other_account
      description: Different logged-in user viewing secret

    recipient_anon: &user_recipient_anon
      auth: incognito
      description: Anonymous visitor in incognito/private window

  fixtures:
    basic_secret: &fixture_secret
      type: secret
      props:
        content: 'Test secret content'
        passphrase: null

tests:
  # -------------------------------------------------------------------------
  # OTS-2114-SC-001: CREATOR views own secret (pre-reveal)
  # -------------------------------------------------------------------------
  - id: OTS-2114-SC-001
    intent: |
      Creator viewing their own secret before revealing sees ownership warning
      and dashboard navigation (not signup CTA)

    setup:
      auth: logged_in
      user_type: creator
      description: User who created the secret being tested
      state:
        has_created_secret: true
      fixtures:
        - type: secret
          props:
            content: 'Test secret content'
            passphrase: null
          capture_as: secret_link

    target: '{{secret_link}}' # Navigate to the secret confirmation page

    # No action needed - just observe the confirmation page
    action:
      type: none

    verify:
      - Yellow/amber warning banner is visible
      - Banner contains text like "You created this secret"
      - Header shows dashboard link (not signup CTA)
      - Secret content is NOT yet revealed (still shows confirmation)
      - selector: "[data-testid='owner-warning']"
        assertion: visible
      - selector: "[data-testid='header-dashboard-link']"
        assertion: exists
      # Fix #1: Explicit confirmation page check to verify secret not yet revealed
      - selector: "[data-testid='secret-confirmation']"
        assertion: visible
        description: Confirmation page is displayed (secret not yet revealed)
      - selector: "[data-testid='secret-content']"
        assertion: hidden
        description: Secret content is NOT visible before reveal action
      - selector: "[data-testid='reveal-button']"
        assertion: visible
        description: Reveal button is present, indicating pre-reveal state

    postconditions:
      - Secret remains unviewed (one-time view NOT consumed)
      - Warning banner can be dismissed
      # Fix #2: Explicit dismiss test for warning banner
      - action: click
        selector: "[data-testid='creator-warning-dismiss']"
        description: Click dismiss button on creator warning banner
      - selector: "[data-testid='owner-warning']"
        assertion: hidden
        description: Warning banner is hidden after dismissal

    priority: high
    severity: major
    type: functional

    covers:
      - useSecretContext
      - actorRole === 'CREATOR'
      - uiConfig.headerAction === 'DASHBOARD_LINK'
      - pre-reveal state

    notes: |
      Tests the CREATOR actor role detection before the secret is revealed.
      The ownership warning prevents creators from accidentally consuming
      their own secret view.

  # -------------------------------------------------------------------------
  # OTS-2114-SC-002: CREATOR views own secret (post-reveal)
  # -------------------------------------------------------------------------
  - id: OTS-2114-SC-002
    intent: |
      Creator who reveals their own secret sees confirmation notice
      and has access to burn control

    setup:
      auth: logged_in
      user_type: creator
      description: User who created the secret being tested
      state:
        has_created_secret: true
      fixtures:
        - type: secret
          props:
            content: 'Test secret content'
            passphrase: null
          capture_as: secret_link

    target: '{{secret_link}}'

    action:
      type: click
      element: 'View Secret button' # Agent finds the reveal button
      selector: "[data-testid='reveal-button']"

    verify:
      - Secret content is now visible
      - Brand-colored notice appears (not yellow warning)
      - Notice mentions viewing own secret
      - Burn button is visible and functional
      - selector: "[data-testid='secret-content']"
        assertion: visible
      - selector: "[data-testid='burn-control']"
        assertion: visible
      # Fix #3: Explicit selector for brand-colored notice (not yellow warning)
      - selector: "[data-testid='creator-notice']"
        assertion: visible
        description: Brand-colored notice is displayed for creator post-reveal
      - selector: "[data-testid='creator-notice']"
        assertion: not_has_class
        class: 'bg-yellow'
        description: Notice uses brand color, not yellow warning style
      - selector: "[data-testid='owner-warning']"
        assertion: hidden
        description: Yellow warning banner is NOT shown post-reveal

    postconditions:
      - Secret is burned (one-time view consumed)
      - Page shows revealed state
      # Fix #4: Explicit validation that secret is burned
      - action: navigate
        url: '{{secret_link}}'
        description: Attempt to revisit the secret link
      - selector: "[data-testid='secret-burned']"
        assertion: visible
        description: Burned/consumed message is displayed on revisit
      - selector: "[data-testid='secret-content']"
        assertion: hidden
        description: Secret content is no longer available

    priority: high
    severity: major
    type: functional

    covers:
      - useSecretContext
      - actorRole === 'CREATOR'
      - uiConfig.showBurnControl === true
      - post-reveal state

    notes: |
      Tests CREATOR role after revealing. The burn control allows creators
      to immediately destroy the secret after viewing.

  # -------------------------------------------------------------------------
  # OTS-2114-SC-003: RECIPIENT_AUTH views someone else's secret
  # -------------------------------------------------------------------------
  - id: OTS-2114-SC-003
    intent: |
      Authenticated user viewing a secret they did NOT create sees no
      ownership warnings and no marketing upsells

    setup:
      auth: logged_in
      user_type: two_accounts # Need Account A (creator) and Account B (viewer)
      state:
        secret_created_by: account_a
        viewing_as: account_b
      fixtures:
        - type: secret
          props:
            content: 'Test secret content'
            passphrase: null
          created_by: account_a
          capture_as: secret_link
      # Verify Account B is authenticated before proceeding
      precondition:
        - api: GET /api/v2/bootstrap/me
          expect:
            status: 200
            body:
              authenticated: true
          description: Confirm Account B is authenticated via bootstrap API

    target: '{{secret_link}}' # Account B navigates here

    action:
      type: none

    verify:
      - NO yellow owner warning banner displayed
      - NO marketing/capabilities upgrade prompt
      - Dashboard link visible in header (user is authenticated)
      - Secret confirmation page functions normally
      - selector: "[data-testid='owner-warning']"
        assertion: hidden
      - selector: "[data-testid='capabilities-upgrade']"
        assertion: hidden
      # Fix #5: Explicit header check for dashboard link with parent context
      - selector: "[data-testid='site-header'] [data-testid='header-dashboard-link']"
        assertion: visible
        description: Dashboard link is visible within the site header
      - selector: "[data-testid='header-signup-cta']"
        assertion: hidden
        description: Signup CTA is NOT shown for authenticated users

    postconditions:
      - Account B can reveal the secret normally
      # Fix #6: Explicit action to verify Account B can reveal secret
      - action: click
        selector: "[data-testid='reveal-button']"
        description: Account B clicks reveal button
      - selector: "[data-testid='secret-content']"
        assertion: visible
        description: Secret content is revealed successfully for Account B
      - selector: "[data-testid='secret-content']"
        assertion: contains_text
        text: 'Test secret content'
        description: Revealed content matches expected secret

    priority: high
    severity: major
    type: functional

    covers:
      - useSecretContext
      - actorRole === 'RECIPIENT_AUTH'
      - uiConfig.showCapabilitiesUpgrade === false

    notes: |
      Tests the RECIPIENT_AUTH role - an authenticated user who is not the
      secret creator. They should see a clean interface without ownership
      warnings or marketing prompts.

  # -------------------------------------------------------------------------
  # OTS-2114-SC-004: RECIPIENT_ANON views secret without login
  # -------------------------------------------------------------------------
  - id: OTS-2114-SC-004
    intent: |
      Anonymous user viewing a secret sees marketing prompts and signup CTA
      but no burn control after reveal

    setup:
      auth: incognito
      description: Anonymous visitor in incognito/private window
      state:
        secret_exists: true # Created by any user beforehand
      fixtures:
        - type: secret
          props:
            content: 'Test secret content'
            passphrase: null
          capture_as: secret_link

    target: '{{secret_link}}'

    action:
      type: click
      element: 'View Secret button'
      selector: "[data-testid='reveal-button']"

    verify:
      # Fix #7: Affirmative page load check before asserting NO owner warning
      # Pre-reveal observations with explicit page load confirmation
      - selector: "[data-testid='secret-confirmation']"
        assertion: visible
        description: Confirmation page loaded successfully
      - selector: "[data-testid='reveal-button']"
        assertion: visible
        description: Reveal button is present (page fully rendered)
      - NO owner warning banner (user is not creator)
      - selector: "[data-testid='owner-warning']"
        assertion: hidden
        description: Owner warning is NOT shown (verified after page load)
      # Fix #8: Marketing prompt with explicit timing - check BEFORE reveal action
      - Marketing/capabilities upgrade prompt is visible
      - selector: "[data-testid='capabilities-upgrade']"
        assertion: visible
        timing: before_action
        description: Marketing prompt visible on confirmation page before reveal
      - Signup CTA in header (not dashboard link)
      - selector: "[data-testid='header-signup-cta']"
        assertion: exists
      # Post-reveal observations
      - Secret content revealed successfully
      - NO burn control visible (anonymous users cannot burn)
      - selector: "[data-testid='capabilities-upgrade']"
        assertion: visible
        timing: after_action
        description: Marketing prompt remains visible after reveal
      - selector: "[data-testid='burn-control']"
        assertion: hidden

    postconditions:
      - Anonymous user viewed secret successfully
      - Marketing messaging was displayed

    priority: high
    severity: major
    type: functional

    covers:
      - useSecretContext
      - actorRole === 'RECIPIENT_ANON'
      - uiConfig.showCapabilitiesUpgrade === true
      - uiConfig.headerAction === 'SIGNUP_CTA'
      - uiConfig.showBurnControl === false

    notes: |
      Tests the RECIPIENT_ANON role - unauthenticated visitors. They see
      marketing prompts encouraging signup but cannot burn secrets.

# etc/defaults/config.defaults.yaml
---
site:
  host: <%= ENV['HOST'] || 'localhost:3000' %>
  # Turns https/http on or off when generating links
  ssl: <%= ENV['SSL'] == 'true' || false %>
  # IMPORTANT: After setting the secret, it should not be changed.
  # Be sure to create and store a backup in a secure offsite
  # location. Changing the secret can lead to unforeseen issues
  # like not being able to decrypt existing secrets.
  secret: <%= ENV['SECRET'] || nil %>
  # API and UI Configuration
  interface:
    ui:
      # Controls whether the web interface is enabled
      # When false, only a basic explanation page is shown
      enabled: <%= ENV['UI_ENABLED'] != 'false' %>
      # Homepage Mode
      #
      # Determines which homepage experience to show based on the request
      # headers. It can change the content presented to a visitor when they
      # navigate to the homepage but it does not expand or restrict access.
      #
      # ✓ Can do: Hide the Create Secret form for external users
      # ✗ Cannot do: Grant access to endpoints for creating secret links
      #
      # This does not protect API endpoints and has no effect on existing
      # authentication or authorization logic.
      #
      # Detection Methods (evaluated in order):
      #   1. matching_cidrs - Client IP must match one of these subnets
      #   2. mode_header - Fallback if no CIDR match (requires header value = mode)
      #
      # Example:
      #   mode: internal
      #   matching_cidrs:
      #     - 203.0.113.0/24      # Office network
      #     - 198.51.100.0/24     # Partner network
      #     - 192.0.2.0/24        # Additional location
      #
      # Example:
      #   mode: external
      #   mode_header: O-Homepage-Mode
      #
      # Privacy Preservation
      #
      # CIDR Subnet Limitations:
      #   - Minimum prefix length: /24 for IPv4 (supports any prefix up to /24, e.g., /8, /12, /16, /24)
      #   - Minimum prefix length: /48 for IPv6 (supports any prefix up to /48)
      #   - Prefix lengths greater than minimum are not supported for privacy
      #
      # Proxy Configuration:
      #   - trusted_proxy_depth: How many proxies to trust for client IP extraction
      #   - 0: Don't trust proxies, use REMOTE_ADDR (direct connections only)
      #   - 1: Trust 1 proxy - STANDARD for reverse proxy (nginx, Caddy)
      #   - 2+: Trust N proxies (e.g., CDN → reverse proxy → app)
      #
      #   - trusted_ip_header: Which header to use for client IP extraction
      #   - X-Forwarded-For: Standard header (most common)
      #   - Forwarded: RFC 7239 standard header
      #   - Both: Try Forwarded first, fallback to X-Forwarded-For
      #
      # Default is 1 (standard reverse proxy) as most deployments use nginx/Caddy.
      # Set to 0 only for development or direct-to-internet deployments.
      #
      homepage:
        mode: <%= ENV['UI_HOMEPAGE_MODE'] || nil %>
        matching_cidrs: <%= ENV['UI_HOMEPAGE_MATCHING_CIDRS']&.split(',')&.map(&:strip) || [] %>
        mode_header: <%= ENV['UI_HOMEPAGE_MODE_HEADER'] || 'O-Homepage-Mode' %>
        trusted_proxy_depth: <%= ENV['UI_HOMEPAGE_TRUSTED_PROXY_DEPTH']&.to_i || 1 %>
        trusted_ip_header: <%= ENV['UI_HOMEPAGE_TRUSTED_IP_HEADER'] || 'X-Forwarded-For' %>
      # Header configuration
      # Controls branding and navigation in the site header
      header:
        # Control switch to enable/disable header customization
        enabled: <%= ENV['HEADER_ENABLED'] != 'false' %>
        # Branding configuration for logo and company name
        branding:
          # Logo configuration
          logo:
            # URL to logo image file
            url: <%= ENV['LOGO_URL'] || 'DefaultLogo.vue' %>
            # Alt text for logo image
            alt: <%= ENV['LOGO_ALT'] || 'Share a Secret One-Time' %>
            # Where the logo links to when clicked
            href: <%= ENV['LOGO_LINK'] || '/' %>
          # DEPRECATED: site_name is deprecated in favor of brand.product_name
          # Use brand.product_name instead (configured in branding section above)
          # site_name: <%= ENV['SITE_NAME'] || 'OTS' %>
        # Navigation configuration
        navigation:
          # Enable/disable header navigation entirely
          enabled: <%= ENV['HEADER_NAV_ENABLED'] != 'false' %>
      # Footer link configuration
      # These links appear in the footer of each page
      footer_links:
        # Global toggle to enable/disable all footer links
        enabled: <%= ENV['FOOTER_LINKS'] == 'true' || false %>
        # Organized groups of links
        groups:

          - name: product
            i18n_key: web.footer.product
            links:
              - text: Pricing
                i18n_key: web.TITLES.pricing
                url: <%= ENV['PRICING_URL'] || 'https://onetimesecret.com/pricing' %>
                external: true
              - text: Source
                i18n_key: web.footer.source_code_purveyor
                url: <%= ENV['SOURCE_URL'] || 'https://github.com/onetimesecret/onetimesecret' %>
                external: true
              - text: Security
                i18n_key: web.footer.security
                url: <%= ENV['SECURITY_URL'] || '/security' %>
                external: true

          - name: support
            i18n_key: web.footer.support
            links:
              - text: Docs
                i18n_key: web.footer.docs
                url: <%= ENV['DOCS_URL'] || 'https://docs.onetimesecret.com/' %>
                external: true
              - text: Contact
                i18n_key: web.footer.contact
                url: <%= ENV['CONTACT_URL'] %>
                external: false
              - text: Status
                i18n_key: web.COMMON.status
                url: <%= ENV['STATUS_URL'] %>
                external: true

          - name: company
            i18n_key: web.footer.company
            links:
              - text: About
                i18n_key: web.COMMON.about
                url: <%= ENV['ABOUT_URL'] %>
                external: <%= ENV['ABOUT_EXTERNAL'] || false %>
              - text: Privacy Policy
                i18n_key: web.layout.privacy_policy
                url: <%= ENV['PRIVACY_URL'] %>
                external: <%= ENV['PRIVACY_EXTERNAL'] || false %>
              - text: Terms of Service
                i18n_key: web.layout.terms_of_service
                url: <%= ENV['TERMS_URL'] %>
                external: <%= ENV['TERMS_EXTERNAL'] || false %>
    # Controls whether the API endpoints are available. When disabled, the API
    # is completely disabled. Requests to /api/* will return 404.
    api:
      enabled: <%= ENV['API_ENABLED'] != 'false' %>
      # Guest API routes for anonymous access
      # When enabled, /api/v3/guest/* endpoints allow unauthenticated requests
      guest_routes:
        # Global toggle - disables all guest routes when false
        enabled: <%= ENV['API_GUEST_ROUTES_ENABLED'] != 'false' %>
        # Fine-grained controls (checked only when enabled=true)
        conceal: <%= ENV['API_GUEST_CONCEAL'] != 'false' %>
        generate: <%= ENV['API_GUEST_GENERATE'] != 'false' %>
        reveal: <%= ENV['API_GUEST_REVEAL'] != 'false' %>
        burn: <%= ENV['API_GUEST_BURN'] != 'false' %>
        show: <%= ENV['API_GUEST_SHOW'] != 'false' %>
        receipt: <%= ENV['API_GUEST_RECEIPT'] != 'false' %>
  # Configuration options for secret management
  secret_options:
    # Default Time-To-Live (TTL) for secrets in seconds
    # This value is used if no specific TTL is provided when creating a secret
    default_ttl: <%= ENV['DEFAULT_TTL'] || nil %>
    # Available TTL options for secret creation (in seconds)
    # These options will be presented to users when they create a new secret
    # Format: String of integers representing seconds
    ttl_options: <%= (ENV['TTL_OPTIONS'] || nil) %>
    # Settings for the passphrase field that protects access to secrets
    passphrase:
      # Require users to enter a passphrase when creating secrets
      required: <%= ENV['PASSPHRASE_REQUIRED'] == 'true' || false %>
      # Minimum number of characters required for passphrases
      minimum_length: <%= ENV['PASSPHRASE_MIN_LENGTH'] || 8 %>
      # Maximum number of characters allowed for passphrases
      maximum_length: <%= ENV['PASSPHRASE_MAX_LENGTH'] || 128 %>
      # Enforce complexity requirements (uppercase, lowercase, numbers, symbols)
      enforce_complexity: <%= ENV['PASSPHRASE_ENFORCE_COMPLEXITY'] == 'true' || false %>
    # Settings for password generation (when users click "Generate Password")
    password_generation:
      # Default length for generated passwords
      default_length: <%= ENV['PASSWORD_GEN_LENGTH'] || 12 %>
      # Character sets to include in generated passwords
      character_sets:
        # Include uppercase letters (A-Z)
        uppercase: <%= ENV['PASSWORD_GEN_UPPERCASE'] != 'false' %>
        # Include lowercase letters (a-z)
        lowercase: <%= ENV['PASSWORD_GEN_LOWERCASE'] != 'false' %>
        # Include numbers (0-9)
        numbers: <%= ENV['PASSWORD_GEN_NUMBERS'] != 'false' %>
        # Include symbols (!@#$%^&*()_+-=[]{}|;:,.<>?)
        symbols: <%= ENV['PASSWORD_GEN_SYMBOLS'] != 'false' %>
        # Exclude ambiguous characters (0, O, l, 1, I) to prevent confusion
        exclude_ambiguous: <%= ENV['PASSWORD_GEN_EXCLUDE_AMBIGUOUS'] != 'false' %>
  # Registration and Authentication settings
  authentication:
    # Can be disabled altogether, including API authentication.
    enabled: <%= ENV['AUTH_ENABLED'] != 'false' %>
    # Allow users to create accounts. This can be disabled if you plan
    # to create accounts manually or enable during setup when accounts
    # can be created and then disabled to prevent any new users from
    # creating accounts.
    signup: <%= ENV['AUTH_SIGNUP'] != 'false' %>
    # Generally if you allow registration, you allow signin. But there
    # are circumstances where it's helpful to turn off authentication
    # temporarily.
    signin: <%= ENV['AUTH_SIGNIN'] != 'false' %>
    # By default, new accounts need to verify their email address before
    # they can sign in. This is a security measure to prevent spamming
    # and abuse of the system. If you're running a private instance or
    # an instance for your team or company, you can disable this feature
    # to make it easier for users to sign in.
    autoverify: <%= ENV['AUTH_AUTOVERIFY'] == 'true' || false %>
    # When enabled, the homepage secret form is not available unless
    # the user is logged in. Similar to a disabled homepage, but still
    # shows the header with logo and navigation links. This allows for
    # a more restrictive mode where only authenticated users can create
    # secrets while maintaining site navigation and branding.
    required: <%= ENV['AUTH_REQUIRED'] == 'true' %>
    # Restrict account creation to specific email domains while allowing
    # secret-sharing with any email address. When set, only email addresses
    # from the listed domains can create accounts. This is useful for
    # organizations that want to limit signups to their own domains while
    # still allowing secrets to be shared with anyone.
    # Format: List of domain names (e.g., example.com, company.org)
    # If empty or not set, signups are allowed from any domain (default).
    # Environment variable: ALLOWED_SIGNUP_DOMAIN (comma-separated list)
    allowed_signup_domains: <%= ENV['ALLOWED_SIGNUP_DOMAIN']&.split(',')&.map(&:strip) || [] %>
  # Links to documentation. For onetimesecret.com, this is
  # docs.onetimesecret.com.
  support:
    host: <%= ENV['SUPPORT_HOST'] || nil %>
  # Session configuration
  # Controls browser cookie and server-side session behavior.
  # Session handling is auth-mode agnostic (works with simple or full mode).
  session:
    # Session secret for HMAC signing. Falls back to site.secret if not set.
    secret: <%= ENV['SESSION_SECRET'] %>
    # Session lifetime in seconds (default: 24 hours)
    expire_after: 86400
    # Cookie name
    key: 'onetime.session'
    # Require HTTPS for cookies (recommended: true in production)
    secure: <%= ENV['SSL'] == 'true' || false %>
    # SameSite cookie attribute (strict|lax|none)
    # Required for Stripe/OAuth redirects - 'strict' blocks cookies on cross-site GET navigations
    same_site: lax
    # Prevent JavaScript access to cookies (always true in Rack)
    httponly: true
  # Middleware Configuration
  # Controls which security and performance middleware components are enabled.
  # Each setting can be overridden via environment variables.
  middleware:
    # Serve static files for frontend vue application
    # ENV: MIDDLEWARE_STATIC_FILES (default: true)
    static_files: <%= ENV['MIDDLEWARE_STATIC_FILES'] != 'false' %>
    # Sanitizes request parameters to ensure proper UTF-8 encoding
    # Prevents encoding-based attacks and malformed input
    # ENV: MIDDLEWARE_UTF8_SANITIZER (default: true)
    utf8_sanitizer: <%= ENV['MIDDLEWARE_UTF8_SANITIZER'] != 'false' %>
    # Protects against Cross-Site Request Forgery (CSRF) attacks
    # Validates that requests originate from the same site
    # ENV: MIDDLEWARE_AUTHENTICITY_TOKEN (default: true)
    authenticity_token: <%= ENV['MIDDLEWARE_AUTHENTICITY_TOKEN'] != 'false' %>
    # Protects against Cross-Site Request Forgery (CSRF) attacks
    # Validates HTTP Origin header matches expected origin
    # ENV: MIDDLEWARE_HTTP_ORIGIN (default: false)
    http_origin: <%= ENV['MIDDLEWARE_HTTP_ORIGIN'] == 'true' %>
    # Sets X-XSS-Protection header to enable browser XSS filtering
    # Modern browsers rely less on this as CSP becomes standard
    # ENV: MIDDLEWARE_XSS_HEADER (default: false)
    xss_header: <%= ENV['MIDDLEWARE_XSS_HEADER'] == 'true' %>
    # Prevents your site from being embedded in frames (clickjacking protection)
    # Sets X-Frame-Options header to SAMEORIGIN or DENY
    # ENV: MIDDLEWARE_FRAME_OPTIONS (default: false)
    frame_options: <%= ENV['MIDDLEWARE_FRAME_OPTIONS'] == 'true' %>
    # Blocks directory traversal attacks using "../" in paths
    # Critical for preventing unauthorized file access
    # ENV: MIDDLEWARE_PATH_TRAVERSAL (default: false)
    path_traversal: <%= ENV['MIDDLEWARE_PATH_TRAVERSAL'] == 'true' %>
    # Protects against cookie tossing attacks
    # Prevents session fixation via manipulated cookies
    # ENV: MIDDLEWARE_COOKIE_TOSSING (default: false)
    cookie_tossing: <%= ENV['MIDDLEWARE_COOKIE_TOSSING'] == 'true' %>
    # Prevents IP spoofing attacks by validating IP addresses
    # Useful when IP-based access controls are implemented
    # ENV: MIDDLEWARE_IP_SPOOFING (default: false)
    ip_spoofing: <%= ENV['MIDDLEWARE_IP_SPOOFING'] == 'true' %>
    # Forces all connections to use HTTPS via HSTS headers
    # Disable only for development or when behind a secure proxy
    # ENV: MIDDLEWARE_STRICT_TRANSPORT (default: false)
    strict_transport: <%= ENV['MIDDLEWARE_STRICT_TRANSPORT'] == 'true' %>
  # Security Configuration
  # Additional security settings beyond middleware
  security:
    # Content Security Policy (CSP) Configuration
    #
    # When enabled, adds Content-Security-Policy headers to responses.
    # - Development mode: Less restrictive headers to allow hot reloading
    # - Production mode: Strict headers with nonce-based script protection
    #
    # The nonce is available via `req.env['onetime.nonce']` for custom
    # script/style assets. Backend views add it automatically.
    #
    # ENV: CSP_ENABLED (default: false)
    csp:
      enabled: <%= ENV['CSP_ENABLED'] == 'true' || false %>

brand:
  primary_color: <%= ENV['BRAND_PRIMARY_COLOR'] ? %Q("#{ENV['BRAND_PRIMARY_COLOR']}") : nil %>
  product_name: <%= ENV['BRAND_PRODUCT_NAME'] || nil %>
  product_domain: <%= ENV['BRAND_PRODUCT_DOMAIN'] || nil %>
  support_email: <%= ENV['BRAND_SUPPORT_EMAIL'] || nil %>
  corner_style: <%= ENV['BRAND_CORNER_STYLE'] || 'rounded' %>
  font_family: <%= ENV['BRAND_FONT_FAMILY'] || 'sans' %>
  button_text_light: <%= ENV['BRAND_BUTTON_TEXT_LIGHT'] != 'false' %>
  allow_public_homepage: <%= ENV['BRAND_ALLOW_PUBLIC_HOMEPAGE'] != 'false' %>
  allow_public_api: <%= ENV['BRAND_ALLOW_PUBLIC_API'] != 'false' %>
  # Logo URL for email templates. When set, overrides the default logo path.
  # Must be an absolute URL (e.g. https://example.com/logo.png).
  # ENV: BRAND_LOGO_URL (default: nil, falls back to baseuri + /img/onetime-logo-v3-xl.svg)
  logo_url: <%= ENV['BRAND_LOGO_URL'] || nil %>
  # TOTP issuer name shown in authenticator apps (e.g. Google Authenticator).
  # Changing this after users have enrolled is cosmetic only—existing codes
  # still work, but the label shown in their authenticator is frozen at
  # enrollment time.
  totp_issuer: <%= ENV['BRAND_TOTP_ISSUER'] || nil %>

features:
  regions:
    enabled: <%= ENV['REGIONS_ENABLED'] == 'true' || false %>
    current_jurisdiction: <%= ENV['JURISDICTION'] || nil %>
    federation_hmac_secret: <%= ENV['FEDERATION_HMAC_SECRET'] || nil %>
  # Incoming Secrets Feature
  # Allows anonymous users to send encrypted secrets to pre-configured recipients
  # via a dedicated web form at /incoming. Recipients receive email notifications.
  incoming:
    # Enable or disable the incoming secrets feature
    enabled: <%= ENV['INCOMING_ENABLED'] == 'true' || false %>
    # Maximum character length for the memo/subject field
    memo_max_length: <%= ENV['INCOMING_MEMO_MAX_LENGTH'] || 50 %>
    # Default TTL for incoming secrets in seconds (7 days = 604800)
    default_ttl: <%= ENV['INCOMING_DEFAULT_TTL'] || 604800 %>
    # Optional default passphrase for all incoming secrets (nil = no passphrase)
    default_passphrase: <%= ENV['INCOMING_DEFAULT_PASSPHRASE'] || nil %>
    # Recipients who can receive incoming secrets
    # Each recipient needs an email and optional display name.
    # Email addresses are hashed at startup and never exposed in API responses.
    #
    # Environment Variable Format:
    #   INCOMING_RECIPIENT_N=email[,name]
    #   where N is 1, 2, 3, etc. and name is optional
    #
    # Examples:
    #   INCOMING_RECIPIENT_1=support@example.com,Support Team
    #   INCOMING_RECIPIENT_2=security@example.com,Security Team
    #   INCOMING_RECIPIENT_3=admin@example.com   (name defaults to 'admin')
    #
    recipients:
      - <%= ENV['INCOMING_RECIPIENT_1']&.split(',') %>
      - <%= ENV['INCOMING_RECIPIENT_2']&.split(',') %>
      - <%= ENV['INCOMING_RECIPIENT_3']&.split(',') %>
      - <%= ENV['INCOMING_RECIPIENT_4']&.split(',') %>
  domains:
    enabled: <%= ENV['DOMAINS_ENABLED'] == 'true' || false %>
    # The default domain used for link URLs. When not set or empty,
    # site.host is used.
    default: <%= ENV['DEFAULT_DOMAIN'] || nil %>

    # Domain validation and certificate management strategy
    # Options:
    #   - passthrough: No validation or cert management
    #   - approximated: Use approximated.app API for SSL certs and validation (requires cluster config)
    #   - caddy_on_demand: Use Caddy's on-demand TLS (requires internal ACME endpoint)
    validation_strategy: <%= ENV['DOMAINS_VALIDATION_STRATEGY'] || 'passthrough' %>

    # Approximated proxy configuration (required for 'approximated' strategy)
    approximated:
      api_key: <%= ENV['APPROXIMATED_API_KEY'] || nil %>
      proxy_ip: <%= ENV['APPROXIMATED_PROXY_IP'] || nil %>
      proxy_host: <%= ENV['APPROXIMATED_PROXY_HOST'] || nil %>
      proxy_name: <%= ENV['APPROXIMATED_PROXY_NAME'] || nil %>
      vhost_target: <%= ENV['APPROXIMATED_VHOST_TARGET'] || nil %>

    # Internal ACME endpoint configuration (for 'caddy_on_demand' strategy)
    # This endpoint allows Caddy to verify domains before issuing certificates
    acme:
      # Enable the internal ACME endpoint at /api/internal/acme/ask
      enabled: <%= ENV['ACME_ENDPOINT_ENABLED'] == 'true' %>
      # IP address to bind to (should always be localhost for security)
      listen_address: <%= ENV['ACME_LISTEN_ADDRESS'] || '127.0.0.1' %>
      # Port for the ACME endpoint (Caddy will call this)
      port: <%= ENV['ACME_PORT'] || '12020' %>

# Main Database Configuration
redis:
  # Redis/Valkey connection URI - Compatible with Redis, Valkey, and other
  # Redis-compatible servers.
  #
  # Environment Variable Precedence (highest to lowest):
  #   1. VALKEY_URL or REDIS_URL - Explicit connection string
  #   2. IN_DOCKER=1 - Force Docker configuration (redis://host.docker.internal:6379)
  #   3. AUTO_DETECT_DOCKER=1 - Enable automatic Docker detection via /.dockerenv file
  #   4. Default - Local development (redis://CHANGEME@127.0.0.1:6379)
  #
  # Format: redis://[:password@]host[:port]/[db-number]
  # Examples:
  #   - redis://mypassword@localhost:6379       # Simple password auth
  #   - redis://user:pass@localhost:6379        # Username/password auth
  #   - redis://host.docker.internal:6379       # Docker environment
  #   - redis://127.0.0.1:6379                  # Local development
  uri: >-
      <%=
        ENV['VALKEY_URL'] ||
        ENV['REDIS_URL'] ||
        (ENV['IN_DOCKER'] == '1' || (ENV['AUTO_DETECT_DOCKER'] == '1' && File.exist?('/.dockerenv')) ?
          'redis://host.docker.internal:6379' :
          'redis://CHANGEME@127.0.0.1:6379')
      %>
  # Database Mapping Configuration
  # By default, all data types use database 0 for simplified connection pooling
  # and compatibility with Redis-as-a-Service providers. For advanced setups,
  # you can separate data across different Redis logical databases (0-15)
  # by setting environment variables or modifying the values below.
  dbs:
    custom_domain: <%= ENV['VALKEY_DBS_CUSTOM_DOMAIN'] || ENV['REDIS_DBS_CUSTOM_DOMAIN'] || 0 %>
    customer: <%= ENV['VALKEY_DBS_CUSTOMER'] || ENV['REDIS_DBS_CUSTOMER'] || 0 %>
    metadata: <%= ENV['VALKEY_DBS_METADATA'] || ENV['REDIS_DBS_METADATA'] || 0 %>
    secret: <%= ENV['VALKEY_DBS_SECRET'] || ENV['REDIS_DBS_SECRET'] || 0 %>
    feedback: <%= ENV['VALKEY_DBS_FEEDBACK'] || ENV['REDIS_DBS_FEEDBACK'] || 0 %>

# Sending Emails
emailer:
  # Local Development with Mailpit
  # -----------------------------
  # Mailpit is a dev SMTP server that captures emails for testing
  # Install: brew install mailpit
  # Start: mailpit
  # Web UI: http://localhost:8025
  #
  #  :mode: smtp                     # Use SMTP mode for local testing
  #  :from: secure@onetimesecret.com # Sender address
  #  :from_name: OTS Support         # Sender name
  #  :host: 127.0.0.1                # Mailpit host
  #  :port: 1025                     # Mailpit default SMTP port
  #  :user: ~                        # No auth needed for Mailpit
  #  :pass: ~                        # No auth needed for Mailpit
  #  :auth: false                    # Disable SMTP auth for Mailpit
  #  :tls: false                     # Disable TLS for local testing

  # Production Settings (for reference)
  # ----------------------------------
  mode: <%= ENV['EMAILER_MODE'] || 'smtp' %>
  region: <%= ENV['EMAILER_REGION'] || 'smtp' %>
  from: <%= ENV['FROM_EMAIL'] || ENV['FROM'] || 'CHANGEME@example.com' %>
  from_name: <%= ENV['FROM_NAME'] || 'Support' %>
  reply_to: <%= ENV['REPLYTO_EMAIL'] || ENV['FROM_EMAIL'] || nil %>
  host: <%= ENV['SMTP_HOST'] || 'smtp.provider.com' %>
  port: <%= ENV['SMTP_PORT'] || 587 %>
  user: <%= ENV['SMTP_USERNAME'] %>
  # The double quotes are important b/c credentials can have characters that break YAML parsing.
  pass: "<%= ENV['SMTP_PASSWORD'] %>"
  auth: <%= ENV['SMTP_AUTH'] || nil %>
  tls: <%= ENV['SMTP_TLS'] %>
mail:
  truemail:
    # Available validation types: :regex, :mx, :mx_blacklist, :smtp
    default_validation_type: :regex
    # Required for :smtp validation
    verifier_email: <%= ENV['VERIFIER_EMAIL'] || 'CHANGEME@example.com' %>
    #:verifier_domain: <%= ENV['VERIFIER_DOMAIN'] || 'example.com' %>
    #:connection_timeout: 2
    #:response_timeout: 2
    #:connection_attempts: 3
    #:validation_type_for:
    #  'example.com': :regex
    #
    # Truemail will only validate email addresses that match the
    # domains listed in :allowed_domains. If the domain is not
    # listed, the email address will always be considered invalid.
    allowed_domains_only: false
    #
    # Email addresses in this list will always be valid.
    #:allowed_emails: []
    #
    # Email addresses in this list will always be invalid.
    #:blocked_emails: []
    #
    # Addresses with these domains will always be valid
    #:allowed_domains: []
    #
    # Addresses with these domains will always be invalid
    #:blocked_domains: []
    #
    # Exclude these IP addresses from the MX lookup process.
    #:blocked_mx_ip_addresses: []
    #
    # Name servers to use for MX et al record lookup.
    # Default is CloudFlare, Google, Oracle/OpenDNS servers.
    dns:
      - 1.1.1.1
      - 8.8.4.4
      - 208.67.220.220
    #:smtp_port: 25
    #
    # End smtp validation after the first invalid response rather than
    # retrying, followed by trying the next server. Can reduce the time
    # time to validate an email address, but may not catch all issues.
    smtp_fail_fast: false
    #
    # Parse the content of the SMTP error message to determine if the
    # email address is valid. This can be useful for some SMTP servers
    # that don't return exact answers.
    smtp_safe_check: true
    #
    # Whether to disable the RFC MX lookup flow. When true, only DNS
    # validation will be performed on MX and Null MX records.
    not_rfc_mx_lookup_flow: false
    #
    # Override default regular expression pattern for email addresses
    # and/or the content in SMTP error messages.
    #:email_pattern: /regex_pattern/
    #:smtp_error_body_pattern: /regex_pattern/
    #
    # Log to the console, a file, or both. The ruby process must have
    # write access to the log file. The log file will be created if it
    # does not exist. Log file rotation is not handled by the app.
    logger:
      # One of: error (default), unrecognized_error, recognized_error, all.
      tracking_event: 'error'
      stdout: true
      # log_absolute_path: '/home/app/log/truemail.log'

# Background Job Processing (RabbitMQ)
# ------------------------------------
# Async processing for emails, notifications, webhooks, and scheduled tasks.
# When disabled, email delivery falls back to synchronous mode.
jobs:
  # Global toggle for background job system
  enabled: <%= ENV['JOBS_ENABLED'] == 'true' || false %>

  # RabbitMQ connection URL
  # Format: amqp://[user:password@]host[:port][/vhost]
  #
  # The vhost dev doesn't exist in RabbitMQ. Either create it:
  #
  #  rabbitmqctl add_vhost dev
  #  rabbitmqctl set_permissions -p dev guest ".*" ".*" ".*"
  #
  rabbitmq_url: <%= ENV['RABBITMQ_URL'] || 'amqp://guest:guest@localhost:5672/dev' %>

  # Publisher settings (Puma process)
  # Channel pool size for multi-threaded web server
  channel_pool_size: <%= ENV['RABBITMQ_CHANNEL_POOL_SIZE']&.to_i || 5 %>

  # Fallback to synchronous delivery when RabbitMQ unavailable
  # Recommended: true for production to ensure emails always send
  fallback_to_sync: <%= ENV['JOBS_FALLBACK_SYNC'] != 'false' %>

  # Worker settings (consumer processes)
  workers:
    email:
      threads: <%= ENV['EMAIL_WORKER_THREADS']&.to_i || 4 %>
      prefetch: <%= ENV['EMAIL_WORKER_PREFETCH']&.to_i || 10 %>
    notifications:
      threads: <%= ENV['NOTIFICATION_WORKER_THREADS']&.to_i || 2 %>
      prefetch: <%= ENV['NOTIFICATION_WORKER_PREFETCH']&.to_i || 10 %>
    billing:
      threads: <%= ENV['BILLING_WORKER_THREADS']&.to_i || 2 %>
      prefetch: <%= ENV['BILLING_WORKER_PREFETCH']&.to_i || 5 %>

  # Scheduler settings (rufus-scheduler daemon)
  scheduler:
    enabled: <%= ENV['JOBS_SCHEDULER_ENABLED'] == 'true' || false %>

  # Plan Cache Refresh Job
  # Proactively refreshes Billing::Plan cache from Stripe API every 6 hours.
  # This ensures plan data remains available even if Stripe webhooks fail.
  # The cache has a 12-hour TTL, so 6-hour refresh provides redundancy.
  # Skips gracefully if no Stripe API key is configured (standalone mode).
  plan_cache_refresh_enabled: <%= ENV['JOBS_PLAN_CACHE_REFRESH_ENABLED'] == 'true' || false %>

  # Catalog Retry Job
  # Retries webhook events that were blocked by the Stripe circuit breaker.
  # When Stripe API is unavailable, catalog update webhooks (product.updated,
  # price.created, etc.) are queued for retry rather than failing. This job
  # processes those queued events once the circuit breaker closes.
  # Runs every 2 minutes when enabled; skips if circuit is still open.
  catalog_retry_enabled: <%= ENV['JOBS_CATALOG_RETRY_ENABLED'] == 'true' || false %>

  # Expiration warning emails
  # Send email notifications before secrets expire to warn recipients
  expiration_warnings:
    # Enable/disable expiration warning emails
    enabled: <%= ENV['JOBS_EXPIRATION_WARNINGS_ENABLED'] == 'true' || false %>
    # How often to scan for expiring secrets (rufus-scheduler interval)
    check_interval: <%= ENV['JOBS_EXPIRATION_CHECK_INTERVAL'] || '1h' %>
    # Send warning N hours before secret expires
    warning_hours: <%= ENV['JOBS_EXPIRATION_WARNING_HOURS']&.to_i || 24 %>
    # Only warn for secrets with TTL greater than this (hours)
    # Prevents spamming for short-lived secrets
    min_ttl_hours: <%= ENV['JOBS_EXPIRATION_MIN_TTL_HOURS']&.to_i || 48 %>
    # Maximum warnings to process per job run (rate limiting)
    # Prevents queue overflow; remaining secrets processed in next run
    batch_size: <%= ENV['JOBS_EXPIRATION_BATCH_SIZE']&.to_i || 100 %>

internationalization:
  enabled: <%= ENV['I18N_ENABLED'] == 'true' || false %>
  default_locale: <%= ENV['I18N_DEFAULT_LOCALE'] || 'en' %>
  fallback_locale:
    fr-CA: [fr_CA, fr_FR, en]
    fr: [fr_FR, fr_CA, en]
    de-AT: [de_AT, de, en]
    de: [de, de_AT, en]
    it: [it_IT, en]
    pt: [pt_BR, en]
    default: [en]
  # A list of ISO language codes (e.g., 'en' for English, 'es'
  # for Spanish, etc.). There is a corresponding file in src/locales
  # with the same name containing the translated text. If it's not
  # selected automatically, users are able to select their preferred
  # language by using the toggle in the footer or in the settings
  # modal if they're logged in.
  locales:
    - bg
    - da_DK
    - de
    - de_AT
    - el_GR
    - en
    - es
    - fr_CA
    - fr_FR
    - it_IT
    - ja
    - ko
    - mi_NZ
    - nl
    - tr
    - uk
    - pl
    - pt_BR
    - sv_SE
  incomplete:
    - ar
    - ca_ES
    - cs
    - he
    - hu
    - pt_PT
    - ru
    - sl_SI
    - vi
    - zh
diagnostics:
  # If this is false, the rest of the settings are ignored
  enabled: <%= ENV['DIAGNOSTICS_ENABLED'] == 'true' || false %>
  sentry:
    # Default Sentry configuration that applies to both frontend and
    # backend. Values set here are overridden by codebase-specific ones.
    #
    # `dsn` - Primary Sentry DSN.
    # `sampleRate` - Percentage of events to sample (0.0 to 1.0)
    # `maxBreadcrumbs` - Maximum number of breadcrumbs to capture
    # `logErrors` - Whether to log errors to console
    defaults:
      dsn: <%= ENV['SENTRY_DSN'] || nil %>
      sampleRate: <%= ENV['SENTRY_SAMPLE_RATE'] || '0.10' %>
      maxBreadcrumbs: <%= ENV['SENTRY_MAX_BREADCRUMBS'] || 5 %>
      logErrors: <%= ENV['SENTRY_LOG_ERRORS'] != 'false' %>
    # Ruby backend-specific Sentry configuration
    #
    # `dsn` - Backend-specific Sentry DSN
    backend:
      dsn: <%= ENV['SENTRY_DSN_BACKEND'] || nil %>
    # Vue frontend-specific Sentry configuration
    # Options here map directly to @sentry/vue client options
    # These options are passed directly to @sentry/vue client initialization
    # and to maintain type safety, they must be typed in
    # src/types/diagnostics.ts DiagnosticsConfig interface.
    #
    # `dsn` - Frontend-specific Sentry DSN
    # `trackComponents` - Enable automatic instrumentation of Vue components
    frontend:
      dsn: <%= ENV['SENTRY_DSN_FRONTEND'] || nil %>
      trackComponents: <%= ENV['SENTRY_VUE_TRACK_COMPONENTS'] != 'false' %>
development:
  # Development Mode Configuration
  #
  # There are two ways to run the frontend in development:
  #
  # 1. Behind a reverse proxy (e.g., Caddy, nginx)
  #    - Set :enabled to true
  #    - Leave :frontend_host empty
  #    - Configure your reverse proxy to handle /dist/* routes
  #
  # 2. Using the built-in rack-proxy (new)
  #    - Set :enabled to true
  #    - Set :frontend_host to 'http://localhost:5173'
  #    - The application will proxy /dist/* requests to the Vite dev server
  #
  # When development mode is enabled, the application expects a Vite
  # development server to be running. This allows live-reloading of frontend
  # changes without rebuilding:
  #
  #   $ pnpm run dev
  #   VITE v5.3.4  ready in 38 ms
  #
  #   -> Local:   http://localhost:5173/dist/
  #   -> Network: use --host to expose
  #   -> press h + enter to show help
  #
  # When disabled (or in production), the application serves pre-built assets
  # from public/web/dist instead.
  #
  enabled: <%= ['development', 'dev'].include?(ENV['RACK_ENV']) %>
  debug: <%= ['true', '1', 'yes'].include?(ENV['ONETIME_DEBUG']) %>
  # Frontend host configuration:
  # - Set to 'http://localhost:5173' to use built-in proxy
  # - Leave empty when using a reverse proxy (like nginx, caddy, etc)
  frontend_host: <%= ENV['FRONTEND_HOST'] || 'http://localhost:5173' %>
  # Domain Context Override for persona-based testing
  #
  # When enabled, allows simulating custom domain experiences without
  # actual DNS/domain setup. Supports three override mechanisms:
  # - DOMAIN_CONTEXT env var: Set at server startup for entire process
  # - O-Domain-Context header: Per-request override for API/curl testing
  # - Colonel UI component: Browser-based override via sessionStorage
  #
  # SECURITY: Must remain false in production. No query param support.
  domain_context_enabled: <%= ENV['DOMAIN_CONTEXT_ENABLED'] == 'true' %>
experimental:
  # SECURITY FEATURE: Allow application to run without a site.secret
  #
  # WHY THIS EXISTS:
  # The application encrypts secret content using site.secret before storing
  # in Redis. If site.secret is nil/empty, encryption still occurs but with
  # a predictable key - making stored data vulnerable. This setting exists
  # to recover secrets that were accidentally created during such a state.
  #
  # DEFAULT: false (application fails to start if site.secret is nil)
  #
  # WARNING: Setting to true presents significant security risks:
  # - Secrets may be stored without proper encryption
  # - Unauthorized access to sensitive data becomes possible
  # - Secret link integrity cannot be guaranteed
  #
  # VALID USE CASES (temporary only):
  # 1. RECOVERY: You accidentally ran with nil secret and need to recover
  #    existing secrets created during that time. Enable temporarily until
  #    all affected secrets expire (max TTL period).
  # 2. MIGRATION: During a controlled migration between encryption schemes,
  #    with proper security measures in place.
  #
  # BEHAVIOR WHEN TRUE:
  # - Application starts without failing
  # - Warning logs appear at startup
  # - When decrypting, CipherErrors with the real secret will cause
  #   automatic retry with nil secret
  #
  # RELATED: rotated_secrets (below) provides a safer rotation mechanism
  # for planned secret changes. Use that instead when possible.
  #
  allow_nil_global_secret: <%= ENV['ALLOW_NIL_GLOBAL_SECRET'] == 'true' || false %>
  # SECURITY FEATURE: Support for rotating global secret
  #
  # FORMAT: Array of strings containing previous secret values
  # ["old_secret_1", "old_secret_2", "oldest_secret"]
  #
  # USAGE: When rotating secrets, add old values here while setting new primary
  # secret in site.secret or SECRET env var. The application will:
  # 1. Use current primary secret for all new encryptions
  # 2. Try each rotated secret (in order) for decryption when primary fails
  #
  # MAINTENANCE: Remove secrets from this list after the relevant secrets
  # have expired or has been successfully re-encrypted with the current
  # primary secret. An easy guideline is the maximum TTL in `ttl_options`.
  #
  # KNOWN LIMITATIONS:
  # - Only works with Secret/Metadata content encryption (LegacyEncryptedFields)
  # - Does NOT work with Familia's EncryptedFields (used for model attributes)
  # - Does NOT affect SESSION_SECRET or HMAC_SECRET (separate systems)
  # - Changing site.secret without proper rotation will break Familia-encrypted
  #   data (e.g., encrypted model fields) - this is a known gap to be addressed
  #
  rotated_secrets: []
